!function(){var e={},t={}
define=function(t,n){e[t]=e[t]||n}
var n=global.require
require=function(r){if(t.hasOwnProperty(r))return t[r]
if(e.hasOwnProperty(r)){var i=t[r]={},o={exports:i},s=e[r]
return s(o,i),t[r]=o.exports}if(n)return n(r)
throw new Error("Can't find module "+r)}}(),define("collab-server",function(e,t){"use strict"
function n(){return process.env.OPENSHIFT_DATA_DIR||process.env.HOME}function r(){var e=process.env,t=e.BASE_PROC?"":String(nt)
return ft.resolve(e.BASE_PROC||e.OPENSHIFT_DATA_DIR||e.HOME,".c9",t)}function i(e){function t(e){try{return require(e+"sqlite3"),st=require(e+"sequelize"),!0
}catch(t){return console.error(t),!1}}if(!st&&!t(_t+"/")&&!t("")){var n=new Error("[vfs-collab] Couldn't load node modules sqlite3 and sequelize from "+_t+" node version: "+process.version+"; node execPath "+process.execPath)
return n.code="EFATAL",e&&e(n)}e&&e()}function o(e,t){return e.success(function(){t.apply(null,[null].concat(Array.prototype.slice.apply(arguments)))
}).error(function(e){s(e,t)})}function s(e,t){if(!e||!xt)return t()
var n=e&&e.message?" "+e.message:""
if(n.match(/duplicate column name/))return t()
if(N({type:"ERROR",err:new Error("Collab encountered error"+n),collabError:e}),console.error("[vfs-collab] CheckDBCorruption encountered error: ",e),"SQLITE_CORRUPT"===e.code||"SQLITE_NOTADB"===e.code||"SQLITE_IOERR"===e.code)return console.error("[vfs-collab] found a corrupted database - backing up and starting with a fresh collab database"),N({type:"ERROR",err:new Error("Collab database corrupt")}),u(t)
if("SQLITE_READONLY"==e.code&&(Et<Date.now()-5e3&&(yt=0),yt++,Et=Date.now(),yt>=bt)){console.error("[vfs-collab] Failed to write "+bt+" times, checking if database is corrupt")
var r=a()
o(r.query("PRAGMA synchronous = 0;"),function(){r.close&&r.close()})}t(e)}function a(){var e=151
rt=rt||ft.join(r(),"collab.db"),i()
var t=new st("c9-collab","c9","c9-collab-secret",{dialect:"sqlite",omitNull:!0,storage:rt,logging:function(t){if(It){var n=t.split(/\r\n|\n|\r/),r=n[0]
r=r.length<e?r:r.substring(0,e)+"..."
var i=n[n.length-1]
i=i.length<e?i:i.substring(i.length-e)+"...",console.error("[vfs-collab] DB",1===n.length?n[0].length<=2*e?n[0]:r+n[0].substring(Math.max(e,n[0].length-e)):r+" --- "+i)
}},define:{underscored:!0,freezeTableName:!1,charset:"utf8",collate:"utf8_general_ci",classMethods:{},instanceMethods:{}},syncOnAssociation:!0,pool:{maxConnections:5,maxIdleTime:30}})
return t}function c(e,t){var n=a()
if(Tt.User=Y=n.define("User",{uid:{type:st.STRING,primaryKey:!0},fullname:{type:st.STRING},email:{type:st.STRING}},{timestamps:!0}),Tt.Workspace=Z=n.define("Workspace",{authorPool:{type:st.TEXT},colorPool:{type:st.TEXT},basePath:{type:st.STRING,allowNull:!1},migration:{type:st.INTEGER,defaultValue:0}},{timestamps:!0}),Tt.Document=$=n.define("Document",{id:{type:st.INTEGER,primaryKey:!0,autoIncrement:!0},path:{type:st.STRING,unique:!0},contents:{type:st.TEXT},fsHash:{type:st.STRING},authAttribs:{type:st.TEXT},starRevNums:{type:st.TEXT},revNum:{type:st.INTEGER,defaultValue:0},created_at:{type:st.DATE,allowNull:!1,defaultValue:st.NOW},updated_at:{type:st.DATE,allowNull:!1,defaultValue:st.NOW},newLineChar:{type:st.STRING,defaultValue:vt}},{timestamps:!1}),Tt.Revision=Q=n.define("Revision",{id:{type:st.INTEGER,primaryKey:!0,autoIncrement:!0},operation:{type:st.TEXT},author:{type:st.STRING},revNum:{type:st.INTEGER},created_at:{type:st.DATE,allowNull:!1,defaultValue:st.NOW},updated_at:{type:st.DATE,allowNull:!1,defaultValue:st.NOW}},{timestamps:!1}),Tt.ChatMessage=et=n.define("ChatMessage",{id:{type:st.INTEGER,primaryKey:!0,autoIncrement:!0},text:{type:st.STRING},userId:{type:st.STRING,allowNull:!1},timestamp:{type:st.DATE,allowNull:!1,defaultValue:st.NOW}},{timestamps:!0}),$.hasMany(Q),Q.belongsTo($),e||!xt)return t()
var r=[{query:"CREATE INDEX DocumentRevisionsIndex ON Revisions(document_id)",skipError:!0},{query:"CREATE INDEX ChatMessageTimestampIndex ON ChatMessages(timestamp)",skipError:!0},{query:"DELETE FROM Documents"},{query:"DELETE FROM Revisions"},{query:"ALTER TABLE Documents ADD COLUMN newLineChar VARCHAR(255)"}]
jt.series([function(e){o(n.query("PRAGMA synchronous = 0;"),e)},function(e){o(Y.sync(),e)},function(e){o(Z.sync(),e)
},function(e){o(n.query("ALTER TABLE Workspaces ADD COLUMN migration INTEGER DEFAULT 0"),e.bind(null,null))
},function(e){o($.sync(),e)},function(e){o(Q.sync(),e)},function(e){o(et.sync(),e)},function(e){o(Z.findOrCreate({id:1},{authorPool:"{}",colorPool:"{}",basePath:tt,migration:r.length}),function(t,n){return t?e(t):(n.authorPool=JSON.parse(n.authorPool),n.colorPool=JSON.parse(n.colorPool),it=n,void e())
})},function(e){var t=it.migration||0
if(t===r.length)return e()
var i=t
jt.forEachSeries(r.slice(t-r.length),function(e,t){console.error("[vfs-collab] applying database migration:",e.query),o(n.query(e.query),function(n){return n&&!e.skipError?t(n):(i++,it.migration=i,void Tt.saveWorkspaceState(it,t))
})},function(t){it.migration!=r.length&&(t=(t?t+" -- ":"")+"Not all migrations could be applied!"),e(t)
})}],function(e){return e?(console.error("[vfs-collab] initDB attempt failed:",e),void s(e,t)):t()})}function u(e){return wt||!xt?e():(console.error("[vfs-collab] resetting collab database"),wt=!0,void ut.rename(rt,rt+".old",function(t){return t&&"ENOENT"!==t.code?(wt=!1,e(t)):void c(!1,function(){wt=!1,N({type:"RESET_DB"}),e()
})}))}function f(e,t){var n=new Error("OT removed text mismatch")
return n.expected=e,n.actual=t,n.code="EMISMATCH",n}function l(e,t){for(var n,r="",i=0,o=e.length;o>i;i+=1)switch(n=e[i].slice(1),e[i][0]){case"r":n=Number(n),r+=t.slice(0,n),t=t.slice(n)
break
case"i":r+=n
break
case"d":if(0!==t.indexOf(n))throw new f(n,t.slice(0,10))
t=t.slice(n.length)
break
default:throw new TypeError("Unknown operation: "+kt.type(e[i]))}return r}function d(e,t){function n(e,t,n,r,i){var o=n,s=e[o],a=e[o+1]
if(0>t||t>s)throw new Error("Invalid index passed!")
a===i?e[o]+=r:t===s?e[o+3]==i?e[o+2]+=r:e.splice(o+2,0,r,i):0===t?e[o-1]==i?e[o-2]+=r:e.splice(o,0,r,i):e.splice(o,2,t,a,r,i,s-t,a)
}function r(e,t,n){for(var r=t.length>>2<<1,i=0,o=0,s=t.splice(r,r+2),a=0;a<s.length;a+=2)o+=s[a]
if(e)e.splice(n+2,0,o,s),e[n]-=o
else{for(var c=t.splice(0,r+2),a=0;a<c.length;a+=2)i+=c[a]
t.push(i,c,o,s)}}function i(e,t,n,i){if(0===e.length)return void e.push(n,i)
var s=o(e,t,n,i)
s&&r(null,e,null)}function o(e,i,s,a){for(var c=0;c<e.length;c+=2){var u=e[c]
if(u>=i){var f=e[c+1]
if(Array.isArray(f)){e[c]+=s
var l=o(f,i,s,a)
l&&r(e,e[c+1],c)}else n(e,i,c,s,a)
return e.length>t}i-=u}}function s(n,r,i){for(var o=0,a=0;a<n.length;a+=2){var c,u=n[a],f=n[a+1]
if(u>=r){if(c=Array.isArray(f)?s(f,r,i):Math.max(0,Math.min(i,u-r)),n[a]-=c,i-=c,o+=c,n[a]?Array.isArray(f)&&f.length<e&&f.length+n.length<=t&&n.splice.apply(n,[a,2].concat(f)):(n.splice(a,2),a-=2),!i)break
r=0}else r-=u}for(var l=0;l<n.length-2;l+=2)n[l]&&n[l+1]===n[l+3]&&(n[l]+=n[l+2],n.splice(l+1,2),l-=2)
return o}function a(e,t,n){n=n||0
for(var r,o=0,a=0;a<t.length;a++)switch(r=kt.length(t[a]),kt.type(t[a])){case"retain":o+=r
break
case"insert":i(e,o,r,n),o+=r
break
case"delete":s(e,o,r)
break
default:throw new TypeError("Unknown operation: "+kt.type(t[a]))}}return e=e||20,t=t||5*e,{apply:a}}function h(e){return ht.createHash("md5").update(e).digest("hex")
}function p(e){return 0===e.indexOf(tt)?e.substring(tt.length+1):e}function m(e,t){if(!At[e])return At[e]=[],t()
var n=setTimeout(function(){throw Error("[vfs-collab] Lock timeout")},6e4)
return At[e].push(function(){clearTimeout(n),t()})}function g(e){var t=At[e]
if(!t||!t.length)return delete At[e]
var n=t.shift()
n()}function v(){var e,t,n
do e=Math.random(),t=Math.random(),n=Math.max(e,t)
while(.001>n)
var r=1/n
e*=r,t*=r,n=.5*Math.random()
var i=new Array(3),o=Math.floor(3*Math.random())%3
i[o]=e
var s=Math.floor(2*Math.random())+1,a=(s+o)%3
i[a]=t
var c=3-(o+a)
return i[c]=n,i=i.map(function(e){return Math.floor(255*e)}),{r:i[0],g:i[1],b:i[2]}}function b(e,t){function n(e){e&&(console.error(e),t.send({type:"CONNECT",error:e}))
}function r(){if(!a)return n("[vfs-collab] Anonyous users connections not supported")
var t=e.fullname,r=e.email
o(Y.find({where:{uid:a}}),function(e,s){return e?n("[vfs-collab] syncUserInfo "+String(e)):s?s.fullname==t&&s.email==r?i():(s.fullname=t,s.email=r,void o(s.save(),function(e){return e?n("[vfs-collab] Failed updating user "+String(e)):void i()
})):o(Y.create({uid:a,fullname:t,email:r}),function(e,t){return e?n("[vfs-collab] Failed creating user "+String(e)):(ot&&ot.push(t),void i())
})})}function i(){Tt.getWorkspaceState(function(e,t){if(e)return n("[vfs-collab] augmentWorkspaceInfo "+String(e))
var r=t.authorPool,i=t.colorPool
return r[a]&&i[a]?s(r,i):(r[a]||(r[a]=Object.keys(r).length+1),i[a]||(i[a]=Ct[r[a]-1]||v()),void Tt.saveWorkspaceState(t,function(e){return e?n("[vfs-collab] augmentWorkspaceInfo "+String(e)):void s(r,i)
}))})}function s(r,i){Tt.getUsers(function(o,s){if(o)return n("[vfs-collab] getUsers "+String(o))
s.length>1&&console.error("[vfs-collab] User",e.userId,"is connecting to a workspace with",s.length-1,"other workspace members")
var u={},f={}
for(var l in ct){var d=ct[l],h=d.userIds.userId
u[h]||(u[h]=[]),u[h].push(l)
var p="idle"===d.state
f[h]="undefined"==typeof f[h]?p:f[h]&&p}Object.keys(u).length>1&&console.error("[vfs-collab] User",e.userId,"is connecting Collab with",Object.keys(ct).length-1,"other clients & online workspace members",u)
var m={}
s.forEach(function(e){var t,n=e.uid,o=u[n]||[]
t=f[n]?"idle":o.length?"online":"offline",m[n]={email:e.email,fullname:e.fullname,uid:e.uid,clients:o,online:o.length,state:t,author:r[n],color:i[n]}
}),N({type:"USER_JOIN",data:{userId:a,clientId:c,user:m[a]}},t),Tt.recentChatHistory(100,function(n,o){n&&console.error("[vfs-collab] recentChatHistory",n),t.send({type:"CONNECT",data:{myClientId:c,myUserId:a,fs:e.fs,authorPool:r,colorPool:i,users:m,chatHistory:o||[]}})
})})}var a=e.userId,c=e.clientId
r()}function y(e){return/r/.test(e)}function E(e){return/w/.test(e)}function w(e,t,n,r,i){function s(o){return o?i(o):(n.revNum++,void Tt.saveDocument(n,function(o){if(o)return i(o)
var s={docId:t,clientId:e.clientId,userId:a,revNum:n.revNum,op:r}
i(null,s)}))}e=e||{userId:0}
var a=e.userId
Tt.getWorkspaceState(function(e,t){if(e)return i(e)
try{n.contents=l(r,n.contents),Nt(n.authAttribs,r,t.authorPool[a]),o(Q.create({operation:new Buffer(JSON.stringify(r)),author:a,revNum:n.revNum+1,document_id:n.id}),s)
}catch(c){return s(c)}})}function x(e,t,n){function r(e){g(s),e&&i(e)}function i(e){t.send({type:"SYNC_COMMIT",data:{docId:s,revNum:o&&o.revNum,reason:e.message||e,code:e.code||"SYNC_E"}})
}var o,s=n.docId,a=e.clientId,c=n.revNum
return Ot[s]&&Ot[s][a]&&t.openDocIds[s]?E(e.fs)?void m(s,function(){Tt.getDocument(s,function(i,a){if(i||!a)return r(i||"No Document to update! "+s)
if(o=a,a.revNum!==c-1){var u=new Error("Version log: "+s+" "+a.revNum+" "+c)
return u.code="VERSION_E",r(u)}w(e,s,a,n.op,function(e,i){if(e){var o=new Error("OT Error: "+String(e))
return o.code="OT_E",r(o)}i.selection=n.selection,N({type:"EDIT_UPDATE",data:i},t,s),delete i.op,delete i.selection,t.send({type:"EDIT_UPDATE",data:i}),St.emit("afterEditUpdate",{docId:s,path:S(s),doc:a}),r()
})})}):r("User "+e.userId+" doesn't have write access to edit document "+s+" - fs: "+e.fs):r("Trying to update a non-member document!",s,a,Ot[s]&&Object.keys(Ot[s]),Object.keys(t.openDocIds),Object.keys(Ot),Object.keys(ct))
}function _(e,t,n){function r(){console.error("[vfs-collab] updateNlChar missing info:",s,o)}function i(e){g(s),e&&console.error("[vfs-collab] updateNlChar failed:",e)
}var o,s=n.docId,a=n.newLineChar||""
switch(a){case"\n":o="\\n"
break
case"\r\n":o="\\r\\n"
break
default:return o=a.length+":"+a,r()}return s?void m(s,function(){Tt.getDocument(s,function(e,n){return e||!n?i((e||"updateNlChar of a non-collab document!")+" : "+s):n.newLineChar==a?i():(n.newLineChar=a,void Tt.saveDocument(n,function(e){return e?i(e):(console.error("[vfs-collab] updateNlChar changed",a),N({type:"UPDATE_NL_CHAR",data:{docId:s,newLineChar:a}},t,s),void i())
}))})}):r()}function I(e,t,n){var r=n.text,i=e.userId
Tt.saveChatMessage(r,i,function(e,t){if(e)return console.error("[vfs-collab] saveChatMessage:",e)
var n={type:"CHAT_MESSAGE",data:{id:t.id,userId:i,timestamp:t.timestamp,text:r}}
N(n)})}function k(e,t,n){var r=n.docId,i=e.clientId
return Ot[r]&&Ot[r][i]&&t.openDocIds[r]?(Ot[r][i].selection=n.selection,n.clientId=i,n.userId=e.userId,void N({type:"CURSOR_UPDATE",data:n},t,r)):console.error("[vfs-collab] Trying to select in a non-member document!",r,i,Ot[r]&&Object.keys(Ot[r]),Object.keys(t.openDocIds),Object.keys(Ot),Object.keys(ct))
}function N(e,t,n){var r=n?Ot[n]:ct,i=0
for(var o in r){var s=ct[o]
s!==t&&s&&(s.send(e),i++)}}function S(e){return"~"===e[0]?ft.join(n(),e.substring(1)):ft.join(tt,e)}function T(e){function t(t){t&&console.error("[vfs-collab] WATCH ERR:",e,t),g(e)
}function n(t,n){var r=new Date(t.mtime).getTime(),i=at[e],o=r-i.mtime
i.mtime&&1>o||m(e,function(){console.error("[vfs-collab] WATCH SYNC:",e,o),i.mtime=r,Tt.getDocument(e,function(t,r){return t?n(t):void R(e,r,function(t,r){return t?n(t):void L(e,r,-1,!0,n)
})})})}var r=S(e)
K.watch(r,{},function(i,o){if(i)return console.error("[vfs-collab] WATCH INIT ERR:",e,i)
var s=o.watcher
s.on("change",function(r,i,o){console.error("[vfs-collab] WATCH CHANGE:",e,"mtime:",new Date(o.mtime).getTime()),n(o,t)
}),s.on("error",function(t){console.error("[vfs-collab] WATCH ERR:",e,t)}),at[e]=s,s.mtime=Date.now(),ut.stat(r,function(e,t){e||(s.mtime=new Date(t.mtime).getTime())
})})}function O(e,t,n){function r(e){e&&(console.error("[vfs-collab] handleJoinDocument ERR:",s,e),t.send({type:"JOIN_DOC",data:{clientId:a,docId:s,err:e}})),g(s)
}function i(e){K.getMetadata(s,{sandbox:tt},function(n,r){n&&console.error("[vfs-collab] Warning: failed to fetch metadata!",s,n)
var i=S(s)
X(i,e.contents,function(n,i){return n&&console.error("[vfs-collab] isVeryLargeFile failed:",n),i?void t.send({type:"LARGE_DOC",data:{userId:c,clientId:a,docId:s,response:!0}}):o(e,String(r||""))
})})}function o(i,o){Ot[s]?console.error("[vfs-collab] User",c,"is joining a document",s,"with",Object.keys(Ot[s]).length,"other document members"):(Ot[s]={},T(s),console.error("[vfs-collab] User",c,"is joining document",s))
var u=h(i.contents),f=JSON.stringify({selections:Ot[s],authAttribs:i.authAttribs,contents:i.contents.toString(),metadata:o,fsHash:i.fsHash,docHash:u,revNum:i.revNum,newLineChar:i.newLineChar,created_at:i.created_at,updated_at:i.updated_at})
Ot[s][a]=e,t.openDocIds[s]=!0
for(var l=10240,d=f.length,p=Math.ceil(d/l),m=0;d>m;m+=l){var g=f.slice(m,m+l)
t.send({type:"JOIN_DOC",data:{userId:c,clientId:a,docId:s,reqId:n.reqId,chunkNum:m/l+1,chunksLength:p,chunk:g}})
}N({type:"JOIN_DOC",data:{docId:s,userId:c,clientId:a}},t),r()}var s=n.docId,a=e.clientId,c=e.userId
console.error("[vfs-collab] User",c,"trying to join document",s),m(s,function(){Tt.getDocument(s,function(e,t){return e?r("getDocument "+String(e)):t&&Ot[s]?i(t):(console.error("[vfs-collab] Joining a closed document",s," - Syncing"),void R(s,t,function(e,t){return e?r(e):void i(t)
}))})})}function A(e){return e.replace(/\r\n|\r/g,"\n")}function C(e){var t=e.match(/^.*?(\r\n|\n)/m)
return t&&t[1]}function R(e,t,n){function r(){ut.readFile(i,"utf8",function(r,i){function o(){s&&a!==s&&(N({type:"UPDATE_NL_CHAR",data:{oldNewLineChar:a,newLineChar:s}},null,e),t.newLineChar=s||a)
}if(r)return n(r)
var s=C(i),a=t&&t.newLineChar||vt,c=A(i),u=h(c)
if(t&&(t.fsHash=h(t.contents)),t)if(u!==t.fsHash&&t.contents!=c){var f=kt.operation(t.contents,c)
console.error("[vfs-collab] SYNC: Updating document:",e,f.length,u,t.fsHash),t.fsHash=u,t.newLineChar=s||a,w(null,e,t,f,function(r,i){return r?n("SYNC: Failed updating OT database document state! "+String(r)):(i.sync=!0,N({type:"EDIT_UPDATE",data:i},null,e),o(),void n(null,t))
})}else o(),n(null,t)
else console.error("[vfs-collab] SYNC: Creating document:",e,u),Tt.newDocument({path:e,contents:c,fsHash:u,newLineChar:s},n)
})}var i=S(e)
V(i,function(e,t){return e?n(new Error("SYNC: Binary check failed - ERR: "+String(e))):t?n(new Error("SYNC: Binary file opened "+t)):void X(i,null,function(e,t){return e?n(e):t?(console.error("[vfs-collab] File is too large, ignoring: "+i),e=new Error("File is too large"),e.code="ELARGE",void n(e)):r()
})})}function D(e,t,n){function r(e){e&&console.error("[vfs-collab] handleGetRevisions ERR:",i,e),g(i)
}var i=n.docId
m(i,function(){Tt.getDocument(i,function(i,o){return i?r("getDocument "+String(i)):void Tt.getRevisions(o,function(i,s){if(i||!s)return r("getRevisions "+(s||[]).length+" "+String(i))
for(var a=JSON.stringify({revisions:s,starRevNums:o.starRevNums,revNum:o.revNum}),c=10240,u=a.length,f=Math.ceil(u/c),l=0;u>l;l+=c){var d=a.slice(l,l+c)
t.send({type:"GET_REVISIONS",data:{userId:e.userId,clientId:e.clientId,docId:n.docId,chunkNum:l/c+1,chunksLength:f,chunk:d}})
}r()})})})}function M(e,t,n){function r(e){g(o),e&&(console.error("[vfs-collab] Failed to save file. docID: "+o+" Err: ",e),t.send({type:"FILE_SAVED",data:{docId:o,err:e}}))
}var i=Date.now(),o=n.docId,s=e.userId
console.error("[vfs-collab] Saving file",o),t.send({type:"FILE_LOCKING",data:{docId:o}}),m(o,function(){t.send({type:"FILE_LOCKED",data:{docId:o}}),Tt.getDocument(o,["contents","revNum","starRevNums","newLineChar"],function(e,a){function c(){var e={bufferWrite:!0},t=e.stream=new dt
t.readable=!0,K.mkfile(f,e,u),t.emit("data",l),t.emit("end")}function u(e){return e?r("Failed saving file ! : "+o+" ERR: "+String(e)):(t.send({type:"DATA_WRITTEN",data:{docId:o}}),void L(o,a,s,!n.silent,function(e){console.error("[vfs-collab] Saving took",Date.now()-i,"ms - file:",o,!e),r(e)
}))}if(e||!a)return r((e||"Writing a non-collab document!")+" : "+o)
at[o]&&(at[o].mtime=Date.now()),t.send({type:"FILE_RETRIEVED",data:{docId:o}})
var f=S(o),l=a.contents.replace(/\n/g,a.newLineChar||gt)
c()})})}function L(e,t,n,r,i){r&&-1===t.starRevNums.indexOf(t.revNum)&&t.starRevNums.push(t.revNum)
var o=t.fsHash=h(t.contents)
Tt.saveDocument(t,function(s){if(s)return i(s)
console.error("[vfs-collab] starRevision added",t.revNum)
var a={userId:n,docId:e,star:r,revNum:t.revNum,fsHash:o}
N({type:"FILE_SAVED",data:a},null,e),i()})}function P(e,t,n){var r=n.docId,i=e.userId,o=e.clientId
return Ot[r]&&Ot[r][o]&&t.openDocIds[r]?(delete t.openDocIds[r],console.error("[vfs-collab]",o,"is leaving document",r),delete Ot[r][o],Object.keys(Ot[r]).length||(console.error("[vfs-collab] Closing document",r),G(r)),void N({type:"LEAVE_DOC",data:{docId:r,userId:i,clientId:o}},t)):console.error("[vfs-collab] Trying to leave a non-member document!",r,o,Ot[r]&&Object.keys(Ot[r]),Object.keys(t.openDocIds),Object.keys(Ot),Object.keys(ct))
}function j(e,t,n){var r=n.docId,i=e.userId,o=e.clientId
console.error("[vfs-collab] ",r),delete Ot[r][o],Object.keys(Ot[r]).length||(console.log("[vfs-collab] File has grown too large, ignoring: "+r),G(r)),N({type:"LARGE_DOC",data:{docId:r,userId:i,clientId:o}},t)
}function U(e,t,n){var r=e.userId,i=e.clientId
console.error("[vfs-collab]",i,"is switching to",n.state),ct[i].state=n.state
var o=Object.keys(ct).map(function(e){return ct[e]}).filter(function(e){return e.userIds.userId===r}).reduce(function(e,t){return e&&"idle"===t.state
},!0)
N({type:"USER_STATE",data:{state:o?"idle":"online",userId:r,clientId:i}},t)}function B(e,t,n){if(console.error("[vfs-collab] Clear chat history: ",n.id,n.clear,e.fs),!E(e.fs))return console.error("[vfs-collab] clearChat: User don't have write access!")
var r
if(n.clear)r=et.destroy({},{truncate:!0})
else{if(!n.id)return console.error("[vfs-collab] clearChat: Invalid message",n)
r=et.destroy({id:n.id})}o(r,function(e){console.error("[vfs-collab] Chat clear:",e?e:"SUCCESS"),e||N({type:"CLEAR_CHAT",data:n})
})}function q(e,t,n){console.error("[vfs-collab] Clear chat history: ",n.id,n.clear,e.fs),N({type:"MESSAGE",data:n},t)
}function F(e,t,n){var r=n.data||{},i=r.docId||""
switch("/"===i[0]&&(r.docId=i.slice(1)),n.type){case"JOIN_DOC":O(e,t,r)
break
case"GET_REVISIONS":D(e,t,r)
break
case"LEAVE_DOC":P(e,t,r)
break
case"LARGE_DOC":j(e,t,r)
break
case"EDIT_UPDATE":x(e,t,r)
break
case"UPDATE_NL_CHAR":_(e,t,r)
break
case"CURSOR_UPDATE":k(e,t,r)
break
case"SAVE_FILE":M(e,t,r)
break
case"CHAT_MESSAGE":I(e,t,r)
break
case"USER_STATE":U(e,t,r)
break
case"CLEAR_CHAT":B(e,t,r)
break
case"PING":t.send({type:"PING"})
break
case"MESSAGE":q(e,t,r)
break
default:throw new Error("Unknown message message type: "+n.type)}}function H(e,t){var n=e.userId,r=e.clientId
console.error("[vfs-collab] CONNECTED UserID: "+n+" & ClientId: "+r),t.on("message",function(n){try{n=JSON.parse(n)
}catch(r){return console.error("[vfs-collab] Can't parse client data!",n)}try{F(e,t,n)}catch(r){return console.error("[vfs-collab] Can't handle user messag",n,r)
}}),b(e,t),t.on("disconnect",function(){for(var i in t.openDocIds)P(e,t,{docId:i})
N({type:"USER_LEAVE",data:{userId:n,clientId:r}},t),console.error("[vfs-collab] DISCONNECTED a socket with userId "+n)
})}function G(e){delete Ot[e],Rt[e]&&clearTimeout(Rt[e]),Rt[e]=setTimeout(function(){delete Rt[e],z(e,{MAX_REVISION_NUM:256,COMPRESSED_REV_NUM:128})
},1e5),at[e]&&(at[e].close(),delete at[e])}function z(e,t,n){function r(t){g(e),t===E&&(t=void 0),t&&console.error("[vfs-collab] ERROR Closing Document",e,t),n&&n(t)
}function i(e,t){return{document_id:e.document_id,operation:e.operation.slice(),author:e.author,revNum:t,created_at:e.created_at,updated_at:e.updated_at}
}function s(e,t){if(t.author!=e.author){if(!_)return!1
t.author="0"}var n=v-e.created_at,r=e.created_at-t.created_at
return I?y<<1>r:S>n?k<<3>r:T>n?N<<2>r:O>n?S>r:y>r}if(!Ot[e]){var a,c,u,f,d,h,p,v,b,y,E="ALREADY_COMPRESSED",w=t.MAX_REVISION_NUM,x=t.COMPRESSED_REV_NUM,_=!1,I=!1,k=1e3,N=60*k,S=60*N,T=24*S,O=T<<2
m(e,function(){jt.series([function(t){Tt.getDocument(e,function(e,n){return e||!n?t(e||"No document to close!"):(u=n.path,a=n,void t())
})},function(e){Tt.getRevisions(a,function(t,n){return t||!n?e(t||"No document revisions found!"):n.length<w?e(E):(c=n,void e())
})},function(e){var t=a.starRevNums.slice(-x)
h={}
var n
for(n=0;n<t.length;n++)h[t[n]]=!0
for(p=a.contents,n=c.length-1;n>0;n--){var r=kt.inverse(c[n].operation)
c[n].contents=p,p=l(r,p)}v=c[c.length-1].created_at,b=v-c[0].created_at,y=b/x,e()},function t(n){var r=c.length-x
console.error("[vfs-collab] Compress document trial",e,r,_,I),f=[i(c[0],0)],d=[]
var o,a,u,m,g={author:-9},v=p
for(u=1;u<c.length&&r;u++){if(m=c[u],a=v,v=l(m.operation,v),s(m,g)){var b=kt.operation(o,v)
g.operation=b,r--}else g=i(m,f.length),f.push(g),o=a
h[u]&&!g.isStar&&(d.push(g.revNum),g.isStar=!0)}if(r){if(!_)return console.error("[vfs-collab] Merge single-author failed to compact the document enough",c.length,f.length),_=!0,t(n)
if(!I)return console.error("[vfs-collab] Merge multi-author failed to compact the document enough",c.length,f.length),I=!0,t(n)
f.length>=w&&console.error("[vfs-collab] All compression modes failed to compact the document enough",c.length,f.length)
}else for(;u<c.length;)f.push(i(c[u++],f.length))
console.error("[vfs-collab] Compressed document:",c.length,f.length,"Different Authors:",_,"isAggressive:",I),n()
},function(e){o(Q.destroy({document_id:a.id}),e)},function(e){a.starRevNums=d,a.revNum=f.length-1,Tt.saveDocument(a,e)
},function(e){f.forEach(function(e){delete e.isStar,e.operation=JSON.stringify(e.operation)}),o(Q.bulkCreate(f),e)
}],r)})}}function W(){var e=lt.createServer(function(t){function n(e){e=e.toString()
for(var n;;){if(n=e.indexOf("\x00\x00"),-1===n)return e&&s.push(e)
s.push(e.substring(0,n))
var r=s.join("")
e=e.substring(n+2),s=[],t.emit("message",r)}}function r(){o||(o=!0,delete ct[i.clientId],t.emit("disconnect"))
}var i,o=!1
t.send=function(e){if(!o){e.command=e.command||"vfs-collab"
var n=JSON.stringify(e)
t.write(n+"\x00\x00")}},t.on("data",function a(r){return t.removeListener("data",a),t.on("data",n),i=JSON.parse(r),y(i.fs)?(t.userIds=i,t.openDocIds={},ct[i.clientId]=t,t.write(r.toString()),void(e.collabInited?H(i,t):e.once("collabInited",function(){H(i,t)
}))):console.error("[vfs-collab] Client don't have read access to workspace! - Note that visitors of private workspaces can't use collab features")
})
var s=[]
t.on("close",r),t.on("end",r),t.on("error",function(e){r(),console.error("[vfs-collab] CLIENT SOCKET ERROR",e),t.destroy()
})})
return e}function J(e,t){function n(){s=W(),console.error("[vfs-collab] PID:",nt,"Socket:",u,"ClinetId:",e.clientId," & UserId:",e.userId),jt.series([function(e){ut.mkdir(ft.dirname(a),function(t){return t&&"EEXIST"!==t.code?e(t):void e()
})},function(e){ut.mkdir(a,function(t){return t&&"EEXIST"!==t.code?e(t):void e()})},function(e){ut.unlink(u,function(t){return t&&"ENOENT"!==t.code?e(t):void e()
})}],function(e){function n(e){try{console.error("[vfs-collab] Shuting down a faulty collab server - reason: ",e),s.close()
}catch(n){console.error("[vfs-collab] Can't shutdown faulty collab server",n)}t(e)}return e?t(e):(s.listen(u,function(){xt=!0,s.collabInited=!1,Ot={},at={},ct={},i(function(e){return e?n(e):void c(!1,function(e){return e?n(e):(s.collabInited=!0,o(),void s.emit("collabInited"))
})}),s.on("close",function(){console.error("[vfs-collab] Server closed")})}),void s.on("error",function(e){return"EADDRINUSE"===e.code?o():void console.error("[vfs-collab] Server error",e)
}))})}function o(){var r=new dt
r.readable=!0
var i=lt.connect(u,function(){function n(e){e=e.toString()
for(var t;;){if(t=e.indexOf("\x00\x00"),-1===t)return o.push(e)
o.push(e.substring(0,t))
var n=o.join("")
e=e.substring(t+2),o=[],r.emit("data",n)}}i.setTimeout(0),i.setNoDelay(!0),i.setKeepAlive(!0),i.userIds=e,i.clientStream=r,i.on("data",function a(){i.removeListener("data",a),i.on("data",n)
})
var o=[]
i.on("close",function(){r.emit("end")}),i.write(JSON.stringify(e),"utf8",function(){t(null,i,xt&&s)})
})
i.on("error",function(e){!e||"ECONNREFUSED"!==e.code&&"ENOENT"!==e.code&&"EAGAIN"!==e.code?(console.error("[vfs-collab] CLIENT SOCK ERR",e,i.userIds),i.write=function(){console.error("[vfs-collab] CLIENT SOCK WRITE AFTER ERROR",i.userIds),console.trace()
},r.emit("end")):n()})}var s,a=r(),u="win32"==process.platform?"\\\\.\\pipe\\"+a+"\\collab.sock":ft.join(a,"collab.sock")
o()}function V(e,t){function n(e,t){if(0===e)return!1
var n=0,i=Math.min(e,r)
if(e>=3&&239==t[0]&&187==t[1]&&191==t[2])return!1
for(var o=0;i>o;o++){if(0===t[o])return!0
if((t[o]<7||t[o]>14)&&(t[o]<32||t[o]>127)){if(t[o]>191&&t[o]<224&&i>o+1){if(o++,t[o]<192)continue}else if(t[o]>223&&t[o]<239&&i>o+2&&(o++,t[o]<192&&t[o+1]<192)){o++
continue}if(n++,o>32&&100*n/i>10)return!0}}return 100*n/i>10?!0:!1}var r=512
mt(e,function(i){return i?void ut.open(e,"r",function(e,i){if(e)return t(e)
var o=new Buffer(r)
ut.read(i,o,0,o.length,0,function(e,r,o){ut.close(i,function(i){return e||i?t(e||i):t(null,n(r,o))})})
}):t(null,!1)})}function X(e,t,n){ut.stat(e,function(e,r){return e?n(e):void n(null,r.size>1048576||t&&t.length>1048576)
})}var K,Y,$,Q,Z,et,tt,nt,rt,it,ot,st,at,ct,ut=require("fs"),ft=require("path"),lt=require("net"),dt=require("stream").Stream,ht=require("crypto"),pt=require("events"),mt=ut.exists||ft.exists,gt="\n",vt="",bt=3,yt=0,Et=0,wt=!1,xt=!1,_t=n()+"/.c9/node_modules",It=!1,kt=function(){function e(e,t){var n=new Pt,r=n.diff_main(e,t)
n.diff_cleanupSemantic(r)
for(var i,o,s,a=[],c=0;c<r.length;c++)switch(i=r[c],o=i[0],s=i[1],o){case Dt:a.push("r"+s.length)
break
case Mt:a.push("i"+s)
break
case Lt:a.push("d"+s)}return a}function t(e){return"i"+e}function n(e){return"d"+e}function r(e){return"r"+String(e)
}function i(e){switch(e[0]){case"r":return"retain"
case"d":return"delete"
case"i":return"insert"
default:throw new TypeError("Unknown type of edit: ",e)}}function o(e){return"retain"===i(e)?~~e.slice(1):e.slice(1)
}function s(e){return"retain"===i(e)?~~e.slice(1):e.length-1}function a(e,t){if("retain"===i(e)){var n=~~e.slice(1)
return["r"+t,"r"+(n-t)]}return[e[0]+e.substring(1,t+1),e[0]+e.substring(t+1)]}function c(e){for(var t=e.slice(),n=0;n<t.length-1;)t[n][0]===t[n+1][0]?t.splice(n,2,t[n][0]+(o(t[n])+o(t[n+1]))):n++
return t}function u(e){for(var r,s,a,c=new Array(e.length),u=0,f=e.length;f>u;u++)switch(r=e[u],s=i(r),a=o(r),s){case"retain":c[u]=e[u]
break
case"insert":c[u]=n(a)
break
case"delete":c[u]=t(a)}return c}return{insert:t,del:n,retain:r,type:i,val:o,length:s,split:a,pack:c,operation:e,inverse:u}
}(),Nt=d().apply,St=new pt.EventEmitter,Tt=function(){function e(e,n){var r=e.contents||""
o($.create({contents:new Buffer(r),path:e.path,fsHash:e.fsHash||h(r),authAttribs:r.length?JSON.stringify([r.length,null]):"[]",starRevNums:"[]",newLineChar:e.newLineChar||vt,revNum:0}),function(e,r){return e?n(e):void o(Q.create({document_id:r.id,operation:new Buffer("[]"),revNum:0}),function(e,i){return e?n(e):(r.revisions=s([i]),void n(null,t(r)))
})})}function t(e){return e.authAttribs&&(e.authAttribs=JSON.parse(e.authAttribs)),e.starRevNums&&(e.starRevNums=JSON.parse(e.starRevNums)),e.contents=e.contents&&e.contents.toString(),e
}function n(e){return function(n,r){return n||!r?e(n):void e(null,t(r))}}function r(e,t,r){var i={where:{path:p(e)}}
return r?(t.unshift("id"),i.attributes=t):(r=t,t=void 0),o($.find(i),n(r))}function i(e,t){o(e.getRevisions(),function(e,n){return e?t(e):void t(null,s(n))
})}function s(e){return e.forEach(function(e){e.operation=JSON.parse(e.operation.toString())}),e.sort(function(e,t){return e.revNum-t.revNum
}),e}function a(e,t){for(var n={},r=0;r<t.length;r++)n[t[r]]=e[t[r]]
return n}function c(e,t,n){n||(n=t,t=void 0)
var r=e.authAttribs,i=e.starRevNums
return e.authAttribs=JSON.stringify(r),e.starRevNums=JSON.stringify(i),e.contents=new Buffer(e.contents),o(t?e.updateAttributes(a(e,t)):e.save(),function(t){e.authAttribs=r,e.starRevNums=i,n(t,e)
})}function u(e){return it?e(null,it):void o(Z.find(1),function(t,n){return t||!n?e(t||"No workspace state found!"):(n.authorPool=JSON.parse(n.authorPool),n.colorPool=JSON.parse(n.colorPool),it=n,void e(null,n))
})}function f(e,t){var n=e.authorPool,r=e.colorPool
return e.authorPool=JSON.stringify(n),e.colorPool=JSON.stringify(r),o(e.save(),function(e,i){return e?(it=null,t(e)):(i.authorPool=n,i.colorPool=r,it=i,void t(null,i))
})}function l(e){return ot?e(null,ot):void o(Y.all(),function(t,n){ot=n,e(t,n)})}function d(e,t,n){o(et.create({text:e,userId:t}),n)
}function m(e,t){e=e||100,o(et.findAll({order:"timestamp DESC",limit:e}),function(e,n){return e?t(e):void t(null,n.reverse())
})}return{newDocument:e,getDocument:r,getRevisions:i,saveDocument:c,getWorkspaceState:u,saveWorkspaceState:f,getUsers:l,saveChatMessage:d,recentChatHistory:m}
}(),Ot={},At={},Ct=[{r:255,g:146,b:45},{r:157,g:47,b:254},{r:105,g:215,b:83},{r:255,g:105,b:130},{r:200,g:109,b:218},{r:210,g:230,b:51},{r:6,g:134,b:255},{r:254,g:13,b:244},{r:188,g:255,b:86},{r:255,g:212,b:125},{r:107,g:4,b:255},{r:66,g:248,b:255}],Rt={},t=e.exports=function(e,t,n){function r(e,n){function r(){a[c]&&(console.error("[vfs-collab] Disposing old client - possible reconnect?",c),o(c))
}var i=t.user,s=t.project,c=e.clientId
if(!(i&&s&&c&&e.basePath))return n(new Error("[OT] Invalid or icomplete collab options passed: "+e.basePath+" "+c))
nt=s.pid||s.id,tt=ft.normalize(e.basePath)
var u={userId:i.uid||i.id,email:i.email,fullname:i.fullname,clientId:c,fs:t.readonly?"r":"rw"}
r(),J(u,function(e,t,i){return e?n(e.message?e:new Error(e)):(t.netServer=i,r(),a[c]=t,void n(null,{stream:t.clientStream,isMaster:xt&&!!i}))
})}function i(e,t){var n=a[e]
n&&n.write(JSON.stringify(t)+"\x00\x00")}function o(e){var t=a[e]
t&&(t.end(),t.destroy(),delete a[e])}function s(e,t,n){return $?void Tt.getDocument(e,t,n):(console.log("Initializing collab db for read access"),c(!0,s.bind(null,e,t,n)))
}var a={}
K=e,t.nodePath&&(_t=t.nodePath),n(null,{connect:r,send:i,dispose:o,getDocument:s,emitter:St})}
t.Store=Tt,t.compressDocument=z,t.checkDBCorruption=s
var Dt=0,Mt=1,Lt=-1,Pt=require("./diff_match_patch"),jt=function(){function e(e,t,n){if(n=n||function(){},!e.length)return n()
var r=0,i=function(){t(e[r],function(t){t?(n(t),n=function(){}):(r+=1,r===e.length?n(null):i())})}
i()}function t(t,n){e(t,function(e,t){e.call(null,function(e){return e?n(e):void t()})},n)}return{series:t,forEachSeries:e}
}()}),define("./diff_match_patch",function(e){function t(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32
}t.prototype.diff_main=function(e,t,n,r){if("undefined"==typeof r&&(r=0>=this.Diff_Timeout?Number.MAX_VALUE:(new Date).getTime()+1e3*this.Diff_Timeout),null==e||null==t)throw Error("Null input. (diff_main)")
if(e==t)return e?[[0,e]]:[]
"undefined"==typeof n&&(n=!0)
var i=n,o=this.diff_commonPrefix(e,t),n=e.substring(0,o),e=e.substring(o),t=t.substring(o),o=this.diff_commonSuffix(e,t),s=e.substring(e.length-o),e=e.substring(0,e.length-o),t=t.substring(0,t.length-o),e=this.diff_compute_(e,t,i,r)
return n&&e.unshift([0,n]),s&&e.push([0,s]),this.diff_cleanupMerge(e),e},t.prototype.diff_compute_=function(e,t,n,r){if(!e)return[[1,t]]
if(!t)return[[-1,e]]
var i=e.length>t.length?e:t,o=e.length>t.length?t:e,s=i.indexOf(o)
return-1!=s?(n=[[1,i.substring(0,s)],[0,o],[1,i.substring(s+o.length)]],e.length>t.length&&(n[0][0]=n[2][0]=-1),n):1==o.length?[[-1,e],[1,t]]:(i=this.diff_halfMatch_(e,t))?(o=i[0],e=i[1],s=i[2],t=i[3],i=i[4],o=this.diff_main(o,s,n,r),n=this.diff_main(e,t,n,r),o.concat([[0,i]],n)):n&&100<e.length&&100<t.length?this.diff_lineMode_(e,t,r):this.diff_bisect_(e,t,r)
},t.prototype.diff_lineMode_=function(e,t,n){var r=this.diff_linesToChars_(e,t),e=r.chars1,t=r.chars2,r=r.lineArray,e=this.diff_main(e,t,!1,n)
this.diff_charsToLines_(e,r),this.diff_cleanupSemantic(e),e.push([0,""])
for(var i=r=t=0,o="",s="";t<e.length;){switch(e[t][0]){case 1:i++,s+=e[t][1]
break
case-1:r++,o+=e[t][1]
break
case 0:if(r>=1&&i>=1){for(e.splice(t-r-i,r+i),t=t-r-i,r=this.diff_main(o,s,!1,n),i=r.length-1;i>=0;i--)e.splice(t,0,r[i])
t+=r.length}r=i=0,s=o=""}t++}return e.pop(),e},t.prototype.diff_bisect_=function(e,t,n){for(var r=e.length,i=t.length,o=Math.ceil((r+i)/2),s=o,a=2*o,c=Array(a),u=Array(a),f=0;a>f;f++)c[f]=-1,u[f]=-1
c[s+1]=0,u[s+1]=0
for(var f=r-i,l=0!=f%2,d=0,h=0,p=0,m=0,g=0;o>g&&!((new Date).getTime()>n);g++){for(var v=-g+d;g-h>=v;v+=2){var b,y=s+v
b=v==-g||v!=g&&c[y-1]<c[y+1]?c[y+1]:c[y-1]+1
for(var E=b-v;r>b&&i>E&&e.charAt(b)==t.charAt(E);)b++,E++
if(c[y]=b,b>r)h+=2
else if(E>i)d+=2
else if(l&&(y=s+f-v,y>=0&&a>y&&-1!=u[y])){var w=r-u[y]
if(b>=w)return this.diff_bisectSplit_(e,t,b,E,n)}}for(v=-g+p;g-m>=v;v+=2){for(y=s+v,w=v==-g||v!=g&&u[y-1]<u[y+1]?u[y+1]:u[y-1]+1,b=w-v;r>w&&i>b&&e.charAt(r-w-1)==t.charAt(i-b-1);)w++,b++
if(u[y]=w,w>r)m+=2
else if(b>i)p+=2
else if(!l&&(y=s+f-v,y>=0&&a>y&&-1!=c[y]&&(b=c[y],E=s+b-y,w=r-w,b>=w)))return this.diff_bisectSplit_(e,t,b,E,n)
}}return[[-1,e],[1,t]]},t.prototype.diff_bisectSplit_=function(e,t,n,r,i){var o=e.substring(0,n),s=t.substring(0,r),e=e.substring(n),t=t.substring(r),o=this.diff_main(o,s,!1,i),i=this.diff_main(e,t,!1,i)
return o.concat(i)},t.prototype.diff_linesToChars_=function(e,t){function n(e){for(var t="",n=0,o=-1,s=r.length;o<e.length-1;){o=e.indexOf("\n",n),-1==o&&(o=e.length-1)
var a=e.substring(n,o+1),n=o+1;(i.hasOwnProperty?i.hasOwnProperty(a):void 0!==i[a])?t+=String.fromCharCode(i[a]):(t+=String.fromCharCode(s),i[a]=s,r[s++]=a)
}return t}var r=[],i={}
r[0]=""
var o=n(e),s=n(t)
return{chars1:o,chars2:s,lineArray:r}},t.prototype.diff_charsToLines_=function(e,t){for(var n=0;n<e.length;n++){for(var r=e[n][1],i=[],o=0;o<r.length;o++)i[o]=t[r.charCodeAt(o)]
e[n][1]=i.join("")}},t.prototype.diff_commonPrefix=function(e,t){if(!e||!t||e.charAt(0)!=t.charAt(0))return 0
for(var n=0,r=Math.min(e.length,t.length),i=r,o=0;i>n;)e.substring(o,i)==t.substring(o,i)?o=n=i:r=i,i=Math.floor((r-n)/2+n)
return i},t.prototype.diff_commonSuffix=function(e,t){if(!e||!t||e.charAt(e.length-1)!=t.charAt(t.length-1))return 0
for(var n=0,r=Math.min(e.length,t.length),i=r,o=0;i>n;)e.substring(e.length-i,e.length-o)==t.substring(t.length-i,t.length-o)?o=n=i:r=i,i=Math.floor((r-n)/2+n)
return i},t.prototype.diff_commonOverlap_=function(e,t){var n=e.length,r=t.length
if(0==n||0==r)return 0
if(n>r?e=e.substring(n-r):r>n&&(t=t.substring(0,n)),n=Math.min(n,r),e==t)return n
for(var r=0,i=1;;){var o=e.substring(n-i),o=t.indexOf(o)
if(-1==o)return r
i+=o,(0==o||e.substring(n-i)==t.substring(0,i))&&(r=i,i++)}},t.prototype.diff_halfMatch_=function(e,t){function n(e,t,n){for(var r,i,o,a,c=e.substring(n,n+Math.floor(e.length/4)),u=-1,f="";-1!=(u=t.indexOf(c,u+1));){var l=s.diff_commonPrefix(e.substring(n),t.substring(u)),d=s.diff_commonSuffix(e.substring(0,n),t.substring(0,u))
f.length<d+l&&(f=t.substring(u-d,u)+t.substring(u,u+l),r=e.substring(0,n-d),i=e.substring(n+l),o=t.substring(0,u-d),a=t.substring(u+l))
}return 2*f.length>=e.length?[r,i,o,a,f]:null}if(0>=this.Diff_Timeout)return null
var r=e.length>t.length?e:t,i=e.length>t.length?t:e
if(4>r.length||2*i.length<r.length)return null
var o,s=this,a=n(r,i,Math.ceil(r.length/4)),r=n(r,i,Math.ceil(r.length/2))
if(!a&&!r)return null
o=r?a&&a[4].length>r[4].length?a:r:a
var c
return e.length>t.length?(a=o[0],r=o[1],i=o[2],c=o[3]):(i=o[0],c=o[1],a=o[2],r=o[3]),o=o[4],[a,r,i,c,o]
},t.prototype.diff_cleanupSemantic=function(e){for(var t=!1,n=[],r=0,i=null,o=0,s=0,a=0,c=0,u=0;o<e.length;)0==e[o][0]?(n[r++]=o,s=c,a=u,u=c=0,i=e[o][1]):(1==e[o][0]?c+=e[o][1].length:u+=e[o][1].length,i&&i.length<=Math.max(s,a)&&i.length<=Math.max(c,u)&&(e.splice(n[r-1],0,[-1,i]),e[n[r-1]+1][0]=1,r--,r--,o=r>0?n[r-1]:-1,u=c=a=s=0,i=null,t=!0)),o++
for(t&&this.diff_cleanupMerge(e),this.diff_cleanupSemanticLossless(e),o=1;o<e.length;)-1==e[o-1][0]&&1==e[o][0]&&(t=e[o-1][1],n=e[o][1],r=this.diff_commonOverlap_(t,n),i=this.diff_commonOverlap_(n,t),r>=i?(r>=t.length/2||r>=n.length/2)&&(e.splice(o,0,[0,n.substring(0,r)]),e[o-1][1]=t.substring(0,t.length-r),e[o+1][1]=n.substring(r),o++):(i>=t.length/2||i>=n.length/2)&&(e.splice(o,0,[0,t.substring(0,i)]),e[o-1][0]=1,e[o-1][1]=n.substring(0,n.length-i),e[o+1][0]=-1,e[o+1][1]=t.substring(i),o++),o++),o++
},t.prototype.diff_cleanupSemanticLossless=function(e){function n(e,n){if(!e||!n)return 6
var r=e.charAt(e.length-1),i=n.charAt(0),o=r.match(t.nonAlphaNumericRegex_),s=i.match(t.nonAlphaNumericRegex_),a=o&&r.match(t.whitespaceRegex_),c=s&&i.match(t.whitespaceRegex_),r=a&&r.match(t.linebreakRegex_),i=c&&i.match(t.linebreakRegex_),u=r&&e.match(t.blanklineEndRegex_),f=i&&n.match(t.blanklineStartRegex_)
return u||f?5:r||i?4:o&&!a&&c?3:a||c?2:o||s?1:0}for(var r=1;r<e.length-1;){if(0==e[r-1][0]&&0==e[r+1][0]){var i=e[r-1][1],o=e[r][1],s=e[r+1][1],a=this.diff_commonSuffix(i,o)
if(a)var c=o.substring(o.length-a),i=i.substring(0,i.length-a),o=c+o.substring(0,o.length-a),s=c+s
for(var a=i,c=o,u=s,f=n(i,o)+n(o,s);o.charAt(0)===s.charAt(0);){var i=i+o.charAt(0),o=o.substring(1)+s.charAt(0),s=s.substring(1),l=n(i,o)+n(o,s)
l>=f&&(f=l,a=i,c=o,u=s)}e[r-1][1]!=a&&(a?e[r-1][1]=a:(e.splice(r-1,1),r--),e[r][1]=c,u?e[r+1][1]=u:(e.splice(r+1,1),r--))
}r++}},t.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,t.whitespaceRegex_=/\s/,t.linebreakRegex_=/[\r\n]/,t.blanklineEndRegex_=/\n\r?\n$/,t.blanklineStartRegex_=/^\r?\n\r?\n/,t.prototype.diff_cleanupEfficiency=function(e){for(var t=!1,n=[],r=0,i=null,o=0,s=!1,a=!1,c=!1,u=!1;o<e.length;)0==e[o][0]?(e[o][1].length<this.Diff_EditCost&&(c||u)?(n[r++]=o,s=c,a=u,i=e[o][1]):(r=0,i=null),c=u=!1):(-1==e[o][0]?u=!0:c=!0,i&&(s&&a&&c&&u||i.length<this.Diff_EditCost/2&&3==s+a+c+u)&&(e.splice(n[r-1],0,[-1,i]),e[n[r-1]+1][0]=1,r--,i=null,s&&a?(c=u=!0,r=0):(r--,o=r>0?n[r-1]:-1,c=u=!1),t=!0)),o++
t&&this.diff_cleanupMerge(e)},t.prototype.diff_cleanupMerge=function(e){e.push([0,""])
for(var t,n=0,r=0,i=0,o="",s="";n<e.length;)switch(e[n][0]){case 1:i++,s+=e[n][1],n++
break
case-1:r++,o+=e[n][1],n++
break
case 0:r+i>1?(0!==r&&0!==i&&(t=this.diff_commonPrefix(s,o),0!==t&&(n-r-i>0&&0==e[n-r-i-1][0]?e[n-r-i-1][1]+=s.substring(0,t):(e.splice(0,0,[0,s.substring(0,t)]),n++),s=s.substring(t),o=o.substring(t)),t=this.diff_commonSuffix(s,o),0!==t&&(e[n][1]=s.substring(s.length-t)+e[n][1],s=s.substring(0,s.length-t),o=o.substring(0,o.length-t))),0===r?e.splice(n-i,r+i,[1,s]):0===i?e.splice(n-r,r+i,[-1,o]):e.splice(n-r-i,r+i,[-1,o],[1,s]),n=n-r-i+(r?1:0)+(i?1:0)+1):0!==n&&0==e[n-1][0]?(e[n-1][1]+=e[n][1],e.splice(n,1)):n++,r=i=0,s=o=""
}for(""===e[e.length-1][1]&&e.pop(),r=!1,n=1;n<e.length-1;)0==e[n-1][0]&&0==e[n+1][0]&&(e[n][1].substring(e[n][1].length-e[n-1][1].length)==e[n-1][1]?(e[n][1]=e[n-1][1]+e[n][1].substring(0,e[n][1].length-e[n-1][1].length),e[n+1][1]=e[n-1][1]+e[n+1][1],e.splice(n-1,1),r=!0):e[n][1].substring(0,e[n+1][1].length)==e[n+1][1]&&(e[n-1][1]+=e[n+1][1],e[n][1]=e[n][1].substring(e[n+1][1].length)+e[n+1][1],e.splice(n+1,1),r=!0)),n++
r&&this.diff_cleanupMerge(e)},t.prototype.diff_xIndex=function(e,t){var n,r=0,i=0,o=0,s=0
for(n=0;n<e.length&&(1!==e[n][0]&&(r+=e[n][1].length),-1!==e[n][0]&&(i+=e[n][1].length),!(r>t));n++)o=r,s=i
return e.length!=n&&-1===e[n][0]?s:s+(t-o)},t.prototype.diff_prettyHtml=function(e){for(var t=[],n=/&/g,r=/</g,i=/>/g,o=/\n/g,s=0;s<e.length;s++){var a=e[s][0],c=e[s][1],c=c.replace(n,"&amp;").replace(r,"&lt;").replace(i,"&gt;").replace(o,"&para;<br>")
switch(a){case 1:t[s]='<ins style="background:#e6ffe6;">'+c+"</ins>"
break
case-1:t[s]='<del style="background:#ffe6e6;">'+c+"</del>"
break
case 0:t[s]="<span>"+c+"</span>"}}return t.join("")},t.prototype.diff_text1=function(e){for(var t=[],n=0;n<e.length;n++)1!==e[n][0]&&(t[n]=e[n][1])
return t.join("")},t.prototype.diff_text2=function(e){for(var t=[],n=0;n<e.length;n++)-1!==e[n][0]&&(t[n]=e[n][1])
return t.join("")},t.prototype.diff_levenshtein=function(e){for(var t=0,n=0,r=0,i=0;i<e.length;i++){var o=e[i][0],s=e[i][1]
switch(o){case 1:n+=s.length
break
case-1:r+=s.length
break
case 0:t+=Math.max(n,r),r=n=0}}return t+=Math.max(n,r)},t.prototype.diff_toDelta=function(e){for(var t=[],n=0;n<e.length;n++)switch(e[n][0]){case 1:t[n]="+"+encodeURI(e[n][1])
break
case-1:t[n]="-"+e[n][1].length
break
case 0:t[n]="="+e[n][1].length}return t.join("	").replace(/%20/g," ")},t.prototype.diff_fromDelta=function(e,t){for(var n=[],r=0,i=0,o=t.split(/\t/g),s=0;s<o.length;s++){var a=o[s].substring(1)
switch(o[s].charAt(0)){case"+":try{n[r++]=[1,decodeURI(a)]}catch(c){throw Error("Illegal escape in diff_fromDelta: "+a)
}break
case"-":case"=":var u=parseInt(a,10)
if(isNaN(u)||0>u)throw Error("Invalid number in diff_fromDelta: "+a)
a=e.substring(i,i+=u),n[r++]="="==o[s].charAt(0)?[0,a]:[-1,a]
break
default:if(o[s])throw Error("Invalid diff operation in diff_fromDelta: "+o[s])}}if(i!=e.length)throw Error("Delta length ("+i+") does not equal source text length ("+e.length+").")
return n},t.prototype.match_main=function(e,t,n){if(null==e||null==t||null==n)throw Error("Null input. (match_main)")
return n=Math.max(0,Math.min(n,e.length)),e==t?0:e.length?e.substring(n,n+t.length)==t?n:this.match_bitap_(e,t,n):-1
},t.prototype.match_bitap_=function(e,t,n){function r(e,r){var i=e/t.length,s=Math.abs(n-r)
return o.Match_Distance?i+s/o.Match_Distance:s?1:i}if(t.length>this.Match_MaxBits)throw Error("Pattern too long for this browser.")
var i=this.match_alphabet_(t),o=this,s=this.Match_Threshold,a=e.indexOf(t,n);-1!=a&&(s=Math.min(r(0,a),s),a=e.lastIndexOf(t,n+t.length),-1!=a&&(s=Math.min(r(0,a),s)))
for(var c,u,f,l=1<<t.length-1,a=-1,d=t.length+e.length,h=0;h<t.length;h++){for(c=0,u=d;u>c;)r(h,n+u)<=s?c=u:d=u,u=Math.floor((d-c)/2+c)
d=u,c=Math.max(1,n-u+1)
var p=Math.min(n+u,e.length)+t.length
for(u=Array(p+2),u[p+1]=(1<<h)-1;p>=c;p--){var m=i[e.charAt(p-1)]
if(u[p]=0===h?(u[p+1]<<1|1)&m:(u[p+1]<<1|1)&m|(f[p+1]|f[p])<<1|1|f[p+1],u[p]&l&&(m=r(h,p-1),s>=m)){if(s=m,a=p-1,!(a>n))break
c=Math.max(1,2*n-a)}}if(r(h+1,n)>s)break
f=u}return a},t.prototype.match_alphabet_=function(e){for(var t={},n=0;n<e.length;n++)t[e.charAt(n)]=0
for(n=0;n<e.length;n++)t[e.charAt(n)]|=1<<e.length-n-1
return t},t.prototype.patch_addContext_=function(e,t){if(0!=t.length){for(var n=t.substring(e.start2,e.start2+e.length1),r=0;t.indexOf(n)!=t.lastIndexOf(n)&&n.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)r+=this.Patch_Margin,n=t.substring(e.start2-r,e.start2+e.length1+r)
r+=this.Patch_Margin,(n=t.substring(e.start2-r,e.start2))&&e.diffs.unshift([0,n]),(r=t.substring(e.start2+e.length1,e.start2+e.length1+r))&&e.diffs.push([0,r]),e.start1-=n.length,e.start2-=n.length,e.length1+=n.length+r.length,e.length2+=n.length+r.length
}},t.prototype.patch_make=function(e,n,r){var i
if("string"==typeof e&&"string"==typeof n&&"undefined"==typeof r)i=e,n=this.diff_main(i,n,!0),2<n.length&&(this.diff_cleanupSemantic(n),this.diff_cleanupEfficiency(n))
else if(e&&"object"==typeof e&&"undefined"==typeof n&&"undefined"==typeof r)n=e,i=this.diff_text1(n)
else if("string"==typeof e&&n&&"object"==typeof n&&"undefined"==typeof r)i=e
else{if("string"!=typeof e||"string"!=typeof n||!r||"object"!=typeof r)throw Error("Unknown call format to patch_make.")
i=e,n=r}if(0===n.length)return[]
for(var r=[],e=new t.patch_obj,o=0,s=0,a=0,c=i,u=0;u<n.length;u++){var f=n[u][0],l=n[u][1]
switch(o||0===f||(e.start1=s,e.start2=a),f){case 1:e.diffs[o++]=n[u],e.length2+=l.length,i=i.substring(0,a)+l+i.substring(a)
break
case-1:e.length1+=l.length,e.diffs[o++]=n[u],i=i.substring(0,a)+i.substring(a+l.length)
break
case 0:l.length<=2*this.Patch_Margin&&o&&n.length!=u+1?(e.diffs[o++]=n[u],e.length1+=l.length,e.length2+=l.length):l.length>=2*this.Patch_Margin&&o&&(this.patch_addContext_(e,c),r.push(e),e=new t.patch_obj,o=0,c=i,s=a)
}1!==f&&(s+=l.length),-1!==f&&(a+=l.length)}return o&&(this.patch_addContext_(e,c),r.push(e)),r},t.prototype.patch_deepCopy=function(e){for(var n=[],r=0;r<e.length;r++){var i=e[r],o=new t.patch_obj
o.diffs=[]
for(var s=0;s<i.diffs.length;s++)o.diffs[s]=i.diffs[s].slice()
o.start1=i.start1,o.start2=i.start2,o.length1=i.length1,o.length2=i.length2,n[r]=o}return n},t.prototype.patch_apply=function(e,t){if(0==e.length)return[t,[]]
var e=this.patch_deepCopy(e),n=this.patch_addPadding(e),t=n+t+n
this.patch_splitMax(e)
for(var r=0,i=[],o=0;o<e.length;o++){var s,a=e[o].start2+r,c=this.diff_text1(e[o].diffs),u=-1
if(c.length>this.Match_MaxBits?(s=this.match_main(t,c.substring(0,this.Match_MaxBits),a),-1!=s&&(u=this.match_main(t,c.substring(c.length-this.Match_MaxBits),a+c.length-this.Match_MaxBits),-1==u||s>=u)&&(s=-1)):s=this.match_main(t,c,a),-1==s)i[o]=!1,r-=e[o].length2-e[o].length1
else if(i[o]=!0,r=s-a,a=-1==u?t.substring(s,s+c.length):t.substring(s,u+this.Match_MaxBits),c==a)t=t.substring(0,s)+this.diff_text2(e[o].diffs)+t.substring(s+c.length)
else if(a=this.diff_main(c,a,!1),c.length>this.Match_MaxBits&&this.diff_levenshtein(a)/c.length>this.Patch_DeleteThreshold)i[o]=!1
else{this.diff_cleanupSemanticLossless(a)
for(var f,c=0,u=0;u<e[o].diffs.length;u++){var l=e[o].diffs[u]
0!==l[0]&&(f=this.diff_xIndex(a,c)),1===l[0]?t=t.substring(0,s+f)+l[1]+t.substring(s+f):-1===l[0]&&(t=t.substring(0,s+f)+t.substring(s+this.diff_xIndex(a,c+l[1].length))),-1!==l[0]&&(c+=l[1].length)
}}}return t=t.substring(n.length,t.length-n.length),[t,i]},t.prototype.patch_addPadding=function(e){for(var t=this.Patch_Margin,n="",r=1;t>=r;r++)n+=String.fromCharCode(r)
for(r=0;r<e.length;r++)e[r].start1+=t,e[r].start2+=t
var r=e[0],i=r.diffs
if(0==i.length||0!=i[0][0])i.unshift([0,n]),r.start1-=t,r.start2-=t,r.length1+=t,r.length2+=t
else if(t>i[0][1].length){var o=t-i[0][1].length
i[0][1]=n.substring(i[0][1].length)+i[0][1],r.start1-=o,r.start2-=o,r.length1+=o,r.length2+=o}return r=e[e.length-1],i=r.diffs,0==i.length||0!=i[i.length-1][0]?(i.push([0,n]),r.length1+=t,r.length2+=t):t>i[i.length-1][1].length&&(o=t-i[i.length-1][1].length,i[i.length-1][1]+=n.substring(0,o),r.length1+=o,r.length2+=o),n
},t.prototype.patch_splitMax=function(e){for(var n=this.Match_MaxBits,r=0;r<e.length;r++)if(!(e[r].length1<=n)){var i=e[r]
e.splice(r--,1)
for(var o=i.start1,s=i.start2,a="";0!==i.diffs.length;){var c=new t.patch_obj,u=!0
for(c.start1=o-a.length,c.start2=s-a.length,""!==a&&(c.length1=c.length2=a.length,c.diffs.push([0,a]));0!==i.diffs.length&&c.length1<n-this.Patch_Margin;){var a=i.diffs[0][0],f=i.diffs[0][1]
1===a?(c.length2+=f.length,s+=f.length,c.diffs.push(i.diffs.shift()),u=!1):-1===a&&1==c.diffs.length&&0==c.diffs[0][0]&&f.length>2*n?(c.length1+=f.length,o+=f.length,u=!1,c.diffs.push([a,f]),i.diffs.shift()):(f=f.substring(0,n-c.length1-this.Patch_Margin),c.length1+=f.length,o+=f.length,0===a?(c.length2+=f.length,s+=f.length):u=!1,c.diffs.push([a,f]),f==i.diffs[0][1]?i.diffs.shift():i.diffs[0][1]=i.diffs[0][1].substring(f.length))
}a=this.diff_text2(c.diffs),a=a.substring(a.length-this.Patch_Margin),f=this.diff_text1(i.diffs).substring(0,this.Patch_Margin),""!==f&&(c.length1+=f.length,c.length2+=f.length,0!==c.diffs.length&&0===c.diffs[c.diffs.length-1][0]?c.diffs[c.diffs.length-1][1]+=f:c.diffs.push([0,f])),u||e.splice(++r,0,c)
}}},t.prototype.patch_toText=function(e){for(var t=[],n=0;n<e.length;n++)t[n]=e[n]
return t.join("")},t.prototype.patch_fromText=function(e){var n=[]
if(!e)return n
for(var e=e.split("\n"),r=0,i=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;r<e.length;){var o=e[r].match(i)
if(!o)throw Error("Invalid patch string: "+e[r])
var s=new t.patch_obj
for(n.push(s),s.start1=parseInt(o[1],10),""===o[2]?(s.start1--,s.length1=1):"0"==o[2]?s.length1=0:(s.start1--,s.length1=parseInt(o[2],10)),s.start2=parseInt(o[3],10),""===o[4]?(s.start2--,s.length2=1):"0"==o[4]?s.length2=0:(s.start2--,s.length2=parseInt(o[4],10)),r++;r<e.length;){o=e[r].charAt(0)
try{var a=decodeURI(e[r].substring(1))}catch(c){throw Error("Illegal escape in patch_fromText: "+a)}if("-"==o)s.diffs.push([-1,a])
else if("+"==o)s.diffs.push([1,a])
else if(" "==o)s.diffs.push([0,a])
else{if("@"==o)break
if(""!==o)throw Error('Invalid patch mode "'+o+'" in: '+a)}r++}}return n},t.patch_obj=function(){this.diffs=[],this.start2=this.start1=null,this.length2=this.length1=0
},t.patch_obj.prototype.toString=function(){var e,t
e=0===this.length1?this.start1+",0":1==this.length1?this.start1+1:this.start1+1+","+this.length1,t=0===this.length2?this.start2+",0":1==this.length2?this.start2+1:this.start2+1+","+this.length2,e=["@@ -"+e+" +"+t+" @@\n"]
var n
for(t=0;t<this.diffs.length;t++){switch(this.diffs[t][0]){case 1:n="+"
break
case-1:n="-"
break
case 0:n=" "}e[t+1]=n+encodeURI(this.diffs[t][1])+"\n"}return e.join("").replace(/%20/g," ")},e.exports=t
}),define("smith",function(e){("undefined"!=typeof e&&function(t){e.exports=t(require("events"),require("msgpack-js"))
}||"function"==typeof define&&function(e){define("smith",["events","msgpack-js"],e)}||function(e){window.smith=e(window.events,window.msgpack)
})(function(e,t){"use strict"
function n(e,t){e.prototype=Object.create(t.prototype,{constructor:{value:e}})}function r(e){function n(e){u(e)
}function r(){c.emit("drain")}function o(e){c.emit("error",e)}function s(){e.removeListener("data",n),e.removeListener("end",s),e.removeListener("timeout",s),e.removeListener("close",s),a.removeListener("drain",r),e.destroy&&e.destroy(),e!==a&&(a.removeListener("end",s),a.removeListener("timeout",s),a.removeListener("close",s),a.destroy&&a!==process.stdout&&a.destroy()),c.emit("disconnect")
}var a,c=this
if(Array.isArray(e)?(a=e[1],e=e[0]):a=e,this.input=e,this.output=a,!e.readable)throw new Error("Input is not readable")
if(!a.writable)throw new Error("Output is not writable")
e.on("data",n),e.on("end",s),e.on("timeout",s),e.on("close",s),e.on("error",o),a.on("drain",r),a!==e&&(a.on("end",s),a.on("timeout",s),a.on("close",s),a.on("error",o))
var u=i(function(e,n){if(e)return c.emit("error",e)
var r
try{r=t.decode(n)}catch(e){return c.emit("error",e)}g.debug&&console.log(process.pid+" <- "+require("util").inspect(r,!1,2,!0)),c.emit("message",r)
})
this.disconnect=s}function i(e){var t,n,r=0,i=0,o=0,s=0
return function(a){for(var c=0,u=a.length;u>c;c++){switch(r){case 0:i|=a[c]<<24,o=0,r=1
break
case 1:i|=a[c]<<16,r=2
break
case 2:i|=a[c]<<8,r=3
break
case 3:i|=a[c],o+=a[c],o+=o<<10,o+=o>>6,o+=o<<3,o^=o>>11,o+=o<<15,o|=0,s=0,r=4
break
case 4:s|=a[c]<<24,r=5
break
case 5:s|=a[c]<<16,r=6
break
case 6:s|=a[c]<<8,r=7
break
case 7:if(s|=a[c],r=8,s!==o)return e(new Error("Hash mismatch, expected: "+o+" got: "+s+", chunk: "+a))
if(i>104857600)return e(new Error("Too big buffer "+i+", chunk: "+a))
t=new Buffer(i),n=0,r=9
break
case 9:r=10
break
case 10:r=11
break
case 11:var f=u-c,l=!1
f+n>=i&&(l=!0,f=i-n),a.copy(t,n,c,c+f),n+=f,c+=f-1,l&&(e(null,t),r=0,i=0,t=void 0,n=void 0)}3>=r&&!l&&(o+=a[c],o+=o<<10,o+=o>>6),l=!1
}}}function o(e){if(!this instanceof o)throw new Error("Forgot to use new with Agent constructor")
this.api=e||{},this.disconnect=this.disconnect.bind(this),this._onMessage=this._onMessage.bind(this),this._onDrain=this._onDrain.bind(this),this._onReady=this._onReady.bind(this),this._getFunction=this._getFunction.bind(this),this._storeFunction=this._storeFunction.bind(this),this.remoteApi={},this.transport=void 0,this.callbacks=void 0,this.nextKey=void 0
}function s(e,t){function n(e,o){var s=c(e)
if("function"!==s&&"object"!==s&&"array"!==s&&"date"!==s)return e
var a=r.indexOf(e)
if(a>=0)return{$:i[a]}
a=r.length,r[a]=e,i[a]=o
var u
return"function"===s&&(u=t(e)),"date"===s&&(u={d:e.getTime()}),u?{$:u}:l(e,function(e,t){return n(e,o.concat([t]))
},null,function(e){return"$"===e[0]?"$"+e:e})}var r=[],i=[]
return n(e,[])}function a(e,t){function n(e,i,o){var s=c(e)
if("$"===o[0]&&(o=o.substr(1)),"function"!==s&&"object"!==s&&"array"!==s)return i[o]=e,e
if(e.hasOwnProperty("$")){var a=e.$
return Array.isArray(a)?(i[o]=u(r.root,a),i[o]):"object"==typeof a?(i[o]=new Date(a.d),i[o]):(i[o]=t(a),i[o])
}var l=Array.isArray(e)?[]:{}
return i[o]=l,f(e,function(e,t){n(e,l,t)}),r}var r={}
return n(e,r,"root"),r.root}function c(e){return null===e?"null":Array.isArray(e)?"array":"undefined"!=typeof Buffer&&Buffer.isBuffer(e)?"buffer":e instanceof Date?"date":typeof e
}function u(e,t){for(var n=e,r=0,i=t.length;i>r;r++)n=n[t[r]]
return n}function f(e,t,n){if("function"==typeof e.forEach)return e.forEach.call(e,t,n)
for(var r=Object.keys(e),i=0,o=r.length;o>i;i++){var s=r[i]
t.call(n,e[s],s,e)}}function l(e,t,n,r){if("function"==typeof e.map)return e.map.call(e,t,n)
for(var i={},o=Object.keys(e),s=0,a=o.length;a>s;s++){var c=o[s]
i[r?r(c):c]=t.call(n,e[c],c,e)}return i}function d(e){function n(e){o.emit("error",e)}function r(e){var r
try{r=t.decode(e)}catch(i){return n(i)}g.debug&&console.log(process.pid+" <- "+require("util").inspect(r,!1,2,!0)),o.emit("message",r)
}function i(){e.removeListener("message",r),e.removeListener("close",i),o.emit("disconnect")}this.socket=e
var o=this
e.on("message",r),e.on("close",i),e.on("error",n),this.disconnect=i}function h(e){function n(e){i.emit("error",e)
}function r(){delete e.onmessage,delete e.onclose,i.emit("disconnect")}this.websocket=e
var i=this
e.binaryType="arraybuffer",e.onmessage=function(e){var r
try{r=t.decode(e.data)}catch(o){return n(o)}g.debug&&console.log("<-",r),i.emit("message",r)},e.onclose=function(){},e.onerror=function(e){n(new Error(e.data))
},this.disconnect=r}function p(e){function t(e){a.emit("error",e)}function n(e){Array.isArray(e)?(g.debug&&console.log("<-",e),a.emit("message",e)):a.emit("legacy",e)
}function r(e){a.emit("disconnect",e),s()}function i(){a.emit("drain")}function o(e){a.emit("disconnect",e),s()
}function s(){e.removeListener("error",t),e.removeListener("message",n),e.removeListener("close",r),e.removeListener("drain",i),e.removeListener("disconnect",o)
}var a=this
this.socket=e,e.on("error",t),e.on("message",n),e.on("close",r),e.on("drain",i),e.on("disconnect",o),this.disconnect=function(){e.close()
},this.send=function(t){return g.debug&&Array.isArray(t)&&console.log("->",t),e.send(t)}}var m=e.EventEmitter,g={}
return g.msgpack=t,g.Agent=o,g.Transport=r,g.deFramer=i,g.liven=a,g.freeze=s,g.getType=c,n(r,m),r.prototype.send=function(e){g.debug&&console.log(process.pid+" -> "+require("util").inspect(e,!1,2,!0))
var n=t.encode(e),r=new Buffer(10)
r.writeUInt32BE(n.length,0)
var i=n.length>>24,o=n.length>>16&255,s=n.length>>8&255,a=255&n.length,c=0
return c+=i,c+=c<<10,c+=c>>6,c+=o,c+=c<<10,c+=c>>6,c+=s,c+=c<<10,c+=c>>6,c+=a,c+=c<<10,c+=c>>6,c+=c<<3,c^=c>>11,c+=c<<15,c|=0,r.writeInt32BE(c,4,!0),r.writeUInt16BE(0,8),this.output.write(r),this.output.write(n)
},n(o,m),o.prototype.connectionTimeout=1e4,o.prototype.connect=function(e,t){function n(e){a(),t&&t(null,e)
}function i(e){o(e||new Error("EDISCONNECT: Agent disconnected"))}function o(e){a(),t?t(e):u.emit("error",e)
}function s(){a()
var e=new Error("ETIMEDOUT: Timeout while waiting for Agent agent to connect.")
e.code="ETIMEDOUT",u.emit("error",e)}function a(){u.removeListener("connect",n),u.removeListener("disconnect",i),u.removeListener("error",o),clearTimeout(c)
}e instanceof r||(e=new r(e)),this.transport=e,this.callbacks={},this.nextKey=1,e.on("error",this.disconnect),e.on("disconnect",this.disconnect),e.on("message",this._onMessage),e.on("drain",this._onDrain),this.send(["ready",this._onReady]),this.on("connect",n),this.on("disconnect",i),this.on("error",o)
var c
this.connectionTimeout&&(c=setTimeout(s,this.connectionTimeout))
var u=this},o.prototype.send=function(e){if(e=s(e,this._storeFunction),!this.transport)return console.log("smith can't send:"),console.dir(e),void console.trace()
try{var t=this.transport.send(e)}catch(n){console.error("Could not send message: ",n.message)}return t
},o.prototype._onReady=function(e,t){if(Array.isArray(e)){var n=this
e.forEach(function(e){n.remoteApi.hasOwnProperty(e)||(n.remoteApi[e]=function(){if(!n.transport){var t=arguments[arguments.length-1]
return void("function"==typeof t&&setTimeout(function(){var e=new Error("ENOTCONNECTED: Agent is offline, try again later")
e.code="ENOTCONNECTED",t(e)},10))}var r=[e]
return r.push.apply(r,arguments),n.send(r)})}),this.remoteEnv=t,this._emitConnect()}},o.prototype._emitConnect=function(){this.emit("connect",this.remoteApi)
},o.prototype.disconnect=function(e){if(this.transport){var t=e
if(t||(t=new Error("EDISCONNECT: Agent disconnected"),t.code="EDISCONNECT"),this.callbacks){var n=this.callbacks
this.callbacks=void 0,f(n,function(e){e(t)})}this.transport&&(this.transport.removeListener("error",this.disconnect),this.transport.removeListener("disconnect",this.disconnect),this.transport.removeListener("message",this._onMessage),this.transport.removeListener("drain",this._onDrain),this.transport.disconnect(),this.transport=void 0),this.emit("disconnect",e),this.nextKey=void 0
}},o.prototype._onDrain=function(){this.emit("drain")},o.prototype._onMessage=function(e){if(!Array.isArray(e)||!e.length)return this.emit("error",new Error("Message should be an array"))
e=a(e,this._getFunction)
var t,n=e[0]
if("ready"===n){var r=Object.keys(this.api),i="undefined"!=typeof process&&process.env
t=function(e){e(r,i)}}else t="string"==typeof n?this.api[n]:this.callbacks[n],t||console.log("MISSING ID",n)
return"function"!=typeof t?this.emit("error",new Error("Should be function")):void t.apply(this,e.slice(1))
},o.prototype._getFunction=function(e){var t=this
return function(){var n=[e]
return n.push.apply(n,arguments),t.send(n)}},o.prototype._storeFunction=function(e){if(!this.callbacks)return new Error("Agent disconnected")
for(var t=this.nextKey;this.callbacks.hasOwnProperty(t);)if(t=t+1>>0,t===this.nextKey)throw new Error("Ran out of keys!!")
this.nextKey=t+1>>0
var n=this.callbacks,r=this
return n[t]=function(){return delete n[t],r.nextKey=t,e.apply(this,arguments)},t},g.WebSocketTransport=d,n(d,r),d.prototype.send=function(e){g.debug&&console.log(process.pid+" -> "+require("util").inspect(e,!1,2,!0))
var n
try{n=t.encode(e)}catch(r){return this.emit("error",r)}this.socket.send(n,{binary:!0})},g.BrowserTransport=h,n(h,r),h.prototype.send=function(e){g.debug&&console.log("->",e)
var n
try{n=t.encode(e)}catch(r){return this.emit("error",r)}this.websocket.send(n)},g.EngineIoTransport=p,n(p,r),g
})}),define("msgpack-js",function(e,t){function n(e,t){this.offset=t||0,this.buffer=e}function r(e){var t=new n(e),r=t.parse()
if(t.offset!==e.length)throw new Error(e.length-t.offset+" trailing bytes")
return r}function i(e,t,n){var r=typeof e
if("string"===r){var o=Buffer.byteLength(e)
if(32>o)return t[n]=160|o,t.write(e,n+1),1+o
if(65536>o)return t[n]=218,t.writeUInt16BE(o,n+1),t.write(e,n+3),3+o
if(4294967296>o)return t[n]=219,t.writeUInt32BE(o,n+1),t.write(e,n+5),5+o}if(Buffer.isBuffer(e)){var o=e.length
if(65536>o)return t[n]=216,t.writeUInt16BE(o,n+1),e.copy(t,n+3),3+o
if(4294967296>o)return t[n]=217,t.writeUInt32BE(o,n+1),e.copy(t,n+5),5+o}if("number"===r){if(e<<0!==e)return t[n]=203,t.writeDoubleBE(e,n+1),9
if(e>=0){if(128>e)return t[n]=e,1
if(256>e)return t[n]=204,t[n+1]=e,2
if(65536>e)return t[n]=205,t.writeUInt16BE(e,n+1),3
if(4294967296>e)return t[n]=206,t.writeUInt32BE(e,n+1),5
if(0x10000000000000000>e)return t[n]=207,t.writeUInt64BE(e,n+1),9
throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return t.writeInt8(e,n),1
if(e>=-128)return t[n]=208,t.writeInt8(e,n+1),2
if(e>=-32768)return t[n]=209,t.writeInt16BE(e,n+1),3
if(e>=-2147483648)return t[n]=210,t.writeInt32BE(e,n+1),5
if(e>=-0x8000000000000000)return t[n]=211,t.writeInt64BE(e,n+1),9
throw new Error("Number too small -0x"+e.toString(16).substr(1))}if("undefined"===r)return t[n]=196,1
if(null===e)return t[n]=192,1
if("boolean"===r)return t[n]=e?195:194,1
if("object"===r){var o,s=0,a=Array.isArray(e)
if(a)o=e.length
else{var c=Object.keys(e)
o=c.length}var s
if(16>o?(t[n]=o|(a?144:128),s=1):65536>o?(t[n]=a?220:222,t.writeUInt16BE(o,n+1),s=3):4294967296>o&&(t[n]=a?221:223,t.writeUInt32BE(o,n+1),s=5),a)for(var u=0;o>u;u++)s+=i(e[u],t,n+s)
else for(var u=0;o>u;u++){var f=c[u]
s+=i(f,t,n+s),s+=i(e[f],t,n+s)}return s}throw new Error("Unknown type "+r)}function o(e){var t=typeof e
if("string"===t){var n=Buffer.byteLength(e)
if(32>n)return 1+n
if(65536>n)return 3+n
if(4294967296>n)return 5+n}if(Buffer.isBuffer(e)){var n=e.length
if(65536>n)return 3+n
if(4294967296>n)return 5+n}if("number"===t){if(e<<0!==e)return 9
if(e>=0){if(128>e)return 1
if(256>e)return 2
if(65536>e)return 3
if(4294967296>e)return 5
if(0x10000000000000000>e)return 9
throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return 1
if(e>=-128)return 2
if(e>=-32768)return 3
if(e>=-2147483648)return 5
if(e>=-0x8000000000000000)return 9
throw new Error("Number too small -0x"+e.toString(16).substr(1))}if("boolean"===t||"undefined"===t||null===e)return 1
if("object"===t){var n,r=0
if(Array.isArray(e)){n=e.length
for(var i=0;n>i;i++)r+=o(e[i])}else{var s=Object.keys(e)
n=s.length
for(var i=0;n>i;i++){var a=s[i]
r+=o(a)+o(e[a])}}if(16>n)return 1+r
if(65536>n)return 3+r
if(4294967296>n)return 5+r
throw new Error("Array or object too long 0x"+n.toString(16))}throw new Error("Unknown type "+t)}t.encode=function(e){var t=new Buffer(o(e))
return i(e,t,0),t},t.decode=r,n.prototype.map=function(e){for(var t={},n=0;e>n;n++){var r=this.parse()
t[r]=this.parse()}return t},n.prototype.buf=function(e){var t=this.buffer.slice(this.offset,this.offset+e)
return this.offset+=e,t},n.prototype.raw=function(e){var t=this.buffer.toString("utf8",this.offset,this.offset+e)
return this.offset+=e,t},n.prototype.array=function(e){for(var t=new Array(e),n=0;e>n;n++)t[n]=this.parse()
return t},n.prototype.parse=function(){var e,t,n=this.buffer[this.offset]
if(160===(224&n))return t=31&n,this.offset++,this.raw(t)
if(128===(240&n))return t=15&n,this.offset++,this.map(t)
if(144===(240&n))return t=15&n,this.offset++,this.array(t)
if(0===(128&n))return this.offset++,n
if(224===(224&n))return e=this.buffer.readInt8(this.offset),this.offset++,e
switch(n){case 218:return t=this.buffer.readUInt16BE(this.offset+1),this.offset+=3,this.raw(t)
case 219:return t=this.buffer.readUInt32BE(this.offset+1),this.offset+=5,this.raw(t)
case 192:return this.offset++,null
case 194:return this.offset++,!1
case 195:return this.offset++,!0
case 196:return void this.offset++
case 204:return e=this.buffer[this.offset+1],this.offset+=2,e
case 205:return e=this.buffer.readUInt16BE(this.offset+1),this.offset+=3,e
case 206:return e=this.buffer.readUInt32BE(this.offset+1),this.offset+=5,e
case 207:return e=this.buffer.readUInt64BE(this.offset+1),this.offset+=9,e
case 208:return e=this.buffer.readInt8(this.offset+1),this.offset+=2,e
case 209:return e=this.buffer.readInt16BE(this.offset+1),this.offset+=3,e
case 210:return e=this.buffer.readInt32BE(this.offset+1),this.offset+=5,e
case 211:return e=this.buffer.readInt64BE(this.offset+1),this.offset+=9,e
case 222:return t=this.buffer.readUInt16BE(this.offset+1),this.offset+=3,this.map(t)
case 223:return t=this.buffer.readUInt32BE(this.offset+1),this.offset+=5,this.map(t)
case 220:return t=this.buffer.readUInt16BE(this.offset+1),this.offset+=3,this.array(t)
case 221:return t=this.buffer.readUInt32BE(this.offset+1),this.offset+=5,this.array(t)
case 216:return t=this.buffer.readUInt16BE(this.offset+1),this.offset+=3,this.buf(t)
case 217:return t=this.buffer.readUInt32BE(this.offset+1),this.offset+=5,this.buf(t)
case 202:return e=this.buffer.readFloatBE(this.offset+1),this.offset+=5,e
case 203:return e=this.buffer.readDoubleBE(this.offset+1),this.offset+=9,e}throw new Error("Unknown type 0x"+n.toString(16))
}}),define("vfs-local",function(e){function t(e){u.appendFile("/tmp/vfs.log",(new Date).getTime()+" "+e+"\n",function(){})
}function n(e,t){function n(e){s.push(e)}function r(){o(),t(null,s.join(""))}function i(e){o(),t(e)}function o(){e.removeListener("data",n),e.removeListener("end",r),e.removeListener("error",i)
}var s=[]
e.on("data",n),e.on("end",r),e.on("error",i)}function r(e,t){var n={},r={exports:n},i=w.runInThisContext("(function(require, exports, module, __dirname, __filename) {"+e+"})",t||"dynamic-"+Date.now().toString(36))
return i(require,n,r,"",""),r.exports}function i(e){return(e.isFile()?"":"W/")+'"'+(e.ino||0).toString(36)+"-"+e.size.toString(36)+"-"+e.mtime.valueOf().toString(36)+'"'
}function o(e){return _.randomBytes(e).toString("base64").slice(0,e).replace(/[+\/]+/g,"")}function s(e,t,n){return h(e,[t||"",o(20),n||""].join(""))
}var a,c,u=require("fs"),f=require("net"),l=require("child_process"),d=require("constants"),h=require("path").join,p=require("path").resolve,m=require("path").normalize,g=require("path").basename,v=require("path").dirname,b=require("path").basename,y=require("stream").Stream,E=require("simple-mime")("application/octet-stream"),w=require("vm"),x=u.exists||require("path").exists,_=require("crypto"),I=require("os"),k=require("path").sep,N="\\"==k
try{c=require("domain")}catch(S){}if(N){var T=m,O=h,A=p
m=function(e){return T(e).replace(/[\\]/g,"/")},h=function(){return O.apply(null,arguments).replace(/[\\]/g,"/")
},a=function(e){if("/"==e[0]){var t=/^\/+(\w):[\/\\]*/.exec(e)
if(t){var n=t?t[1]:""
e=n+":/"+e.substr(t[0].length).replace(/[:*?"<>|]/g,"_")}}return e},p=function(e,t){return e=A(e,t),"/"!==e[0]&&(e="/"+e.replace(/[\\]/g,"/")),e
}}e.exports=function(e){function o(e){if(!c)return e
for(var t in e)"function"==typeof e[t]&&!function(t){var n=e[t]
e[t]=function(){var r=Array.prototype.slice.apply(arguments),i=c.create()
i.on("error",function(e){console.error("VFS Exception in function '"+t+"':\n",e.stack||e),Ot.emit("error",{message:e.message,func:t,stack:e.stack+"",node:process.version}),console.log("Scheduling process exit"),setTimeout(function(){console.log("Exiting after uncaught exception in '"+t+"':\n",e.stack||e),process.exit(1)
},2e3)}),i.run(function(){n.apply(e,r)})}}(t)
return e}function w(){var e=arguments[arguments.length-1]
try{return l.execFile.apply(l,arguments)}catch(t){e(t)}}function _(t,n,r){r||(r=n,n={})
var i=n.alreadyRooted,o=n.checkSymlinks,s=n.sandbox
if(void 0===o&&(o=!0),i||(s&&(t=h(s,t)),t=h(xt,t)),!n.nocheck){var c=s?h(xt,s):xt,f=xt.substr(0,c.length-1),l=t.substr(0,c.length)
if(N&&(l=l.toLowerCase(),f=f.toLowerCase(),c=c.toLowerCase()),t!==f&&l!==c){var d=!0
if(d){var p=new Error("EACCESS: '"+t+"' not in '"+c+"'")
return p.code="EACCESS",r(p)}}}a&&(t=a(t)),(o&&e.checkSymlinks||2==o)&&!i?u.realpath(t,r):r(null,t)}function S(e,t,n,r,i){_(e,r,function(e,r){return e?i(e):void u.open(r,t,n,function(e,t){return e?i(e):void u.fstat(t,function(e,n){return e?i(e):void i(null,r,t,n)
})})})}function T(e,t,n,r){u.lstat(t,function(i,o){var s={name:e}
return i?(s.err=i,n(s)):(s.size=o.size,s.mtime=o.mtime.valueOf(),s.mime=o.isDirectory()?"inode/directory":o.isBlockDevice()?"inode/blockdevice":o.isCharacterDevice()?"inode/chardevice":o.isSymbolicLink()?"inode/symlink":o.isFIFO()?"inode/fifo":o.isSocket()?"inode/socket":E(t),o.isSymbolicLink()?void u.readlink(t,function(e,i){if(e)return s.linkErr=e.stack,n(s)
var o=p(v(t),i)
return r||(r={fullLinkPath:t,max:100}),o.toLowerCase()==r.fullLinkPath.toLowerCase()||r.max--<0?(s.linkErr="ELOOP: recursive symlink",n(s)):(s.link=i,void _(o,{alreadyRooted:!0},function(e,t){return e?(s.linkErr=e,n(s)):void T(b(t),t,function(e){return s.linkStat=e,e.fullPath=t.substr(_t.length)||"/",n(s)
},r)}))}):n(s))})}function O(e,t,n,r){var i={}
_(e,n,function(o,s){return o?r(o):void t(s,function(o){return o?r(o):void _(yt+e,n,function(e,n){return e?r(null,i):void t(n,function(){return r(null,i)
})})})})}function A(e,t,n){_(e,t,function(e,t){return e?n(e):void n(null,{path:t})})}function C(e,t,n){_(v(e),t,function(t,r){if(t)return n(t)
var i=b(e)
e=h(r,i),T(i,e,function(e){return e.err?n(e.err):void n(null,e)})})}function R(e,t,n){"~"==e.charAt(0)&&(e=h(process.env.HOME,e.substr(1)))
var r="/_/_/"==e.substr(0,5)?bt+v(e.substr(4)):yt+"/"+v(e)
_(r,t,function(r,i){if(r)return n(r)
var o=b(e)
e=h(i,o),"\\"===k&&(i=i.replace(/\\/g,"/")),nt("mkdir",{args:["-p",i]},function(r){return r?n(r):void u.writeFile(e,JSON.stringify(t.metadata),{},function(e){return e?n(e):void n(null,{})
})})})}function D(e,t,n){"~"==e.charAt(0)&&(e=h(process.env.HOME,e.substr(1)))
var r=h(yt,e)
_(r,t,function(e,t){return e?n(e):void u.readFile(t,n)})}function M(e,t,n){var r={},o=e
S(e,"r",438&~It,t,function(e,s,a,c){function f(e){if(t.hasOwnProperty("head"))return u.close(a),n(null,r)
try{t.fd=a,r.stream=new u.ReadStream(s,t)}catch(i){return u.close(a),n(i)}if(e){var o=r.stream
r.stream=new y,r.stream.readable=!0,r.stream.writable=!0,r.stream.write=function(e){return r.stream.emit("data",e),!0
},r.stream.end=function(e){r.stream.emit("end",e)},o.pipe(r.stream,{end:!1}),o.on("end",function(){r.stream.write(p),r.stream.end()
}),r.stream.destroy=function(){o.destroy()}}n(null,r)}if(e)return n(e)
if(c.isDirectory())return u.close(a),e=new Error("EISDIR: Requested resource is a directory"),e.code="EISDIR",n(e)
if(r.mime=E(s),r.size=c.size,r.etag=i(c),(Et||c.mtime%1e3)&&t.etag===r.etag)return r.notModified=!0,u.close(a),n(null,r)
if(t.hasOwnProperty("range")&&(!t.range.etag||t.range.etag===r.etag)){var l,d,h=t.range
if(h.hasOwnProperty("start"))l=h.start,d=h.hasOwnProperty("end")?h.end:r.size-1
else{if(!h.hasOwnProperty("end"))return r.rangeNotSatisfiable="Invalid Range",u.close(a),n(null,r)
l=r.size-h.end,d=r.size-1}if(l>d||0>l||d>=c.size)return r.rangeNotSatisfiable="Range out of bounds",u.close(a),n(null,r)
t.start=l,t.end=d,r.size=d-l+1,r.partialContent={start:l,end:d,size:c.size}}var p
t.hasOwnProperty("metadata")&&-1==o.indexOf(yt)?D(o,t,function(e,t){if(e)return f()
try{r.metadataSize=t.length,r.metadataStringLength=t.toString("utf8").length,p=t,f(!0)}catch(n){u.close(a),f()
}}):f()})}function L(e,t,n){var r={}
_(e,t,function(e,o){return e?n(e):void(N&&At&&At(o,n)||u.stat(o,function(e,s){return e?n(e):s.isDirectory()?(r.etag=i(s),(Et||s.mtime%1e3)&&t.etag===r.etag?(r.notModified=!0,n(null,r)):void u.readdir(o,function(e,i){function s(){if(f===i.length)return a()
var e=i[f++],t=h(o,e)
T(e,t,function(e){c.emit("data",e),u||s()})}function a(){c.emit("end")}if(e)return n(e)
if(t.head)return n(null,r)
var c=new y
c.readable=!0
var u
c.pause=function(){u!==!0&&(u=!0)},c.resume=function(){u!==!1&&(u=!1,s())},r.stream=c,n(null,r)
var f=0
c.resume()})):(e=new Error("ENOTDIR: Requested resource is not a directory"),e.code="ENOTDIR",n(e))}))
})}function P(e,t,n){function r(e){x.push(["data",e])}function i(){x.push(["end"])}function o(e){return a(),I?void u.unlink(I,E.bind(null,e)):E(e)
}function a(){w&&(w.removeListener("data",r),w.removeListener("end",i),x.forEach(function(e){w.emit.apply(w,e)
}),w.resume&&w.resume())}function c(){t.parents?j(v(e),t,function(e){return e?o(e):void f()}):f()}function f(){t.checkSymlinks=2,_(e,t,function(n,r){return n?"ENOENT"!==n.code?o(n):void _(v(e),t,function(t,n){return t?o(t):(k=h(n,b(e)),void l())
}):(k=r,void l())})}function l(){function e(n,r,i){function s(e,t,n,r){u.fstat(e,function(i,o){return i?r(i):o.uid==t&&o.gid==n?r():void u.fchown(e,t,n,r)
})}if(n)return"ENOENT"===n.code?u.stat(v(k),function(t,n){e(t,n,!0)}):o(n)
var a=process.getuid?process.getuid():0,c=process.getgid?process.getgid():0
r&&(c=r.gid,i||(N=511&r.mode,a=r.uid))
var f=d.O_CREAT|d.O_WRONLY|d.O_EXCL
u.open(I,f,N,t,function(e,n){return e?m():void s(n,a,c,function(e){return u.close(n),e?(u.unlink(I),m()):void m(new u.WriteStream(I,{encoding:t.encoding||null,mode:N}))
})})}return t.bufferWrite?p():(I=s(v(k),"."+b(k)+"-","~"),void u.stat(k,e))}function p(){var e,t=[]
w.on("data",function(e){t.push(new Buffer(e))}),w.on("error",function(t){e=t,o(t)}),w.on("end",function(){e||V(k,function(e){u.writeFile(k,Buffer.concat(t),function(t){e(function(){return t?o(t):void E()
})})})}),a()}function m(e){var n,r=!0
e||(r=!1,e=new u.WriteStream(k,{encoding:t.encoding||null,mode:N})),w?w.pipe(e):e.on("open",function(){n||(y.stream=e,E())
}),e.on("error",function(e){n=!0,o(e)})
var i=e.emit
e.emit=function(t){var s=arguments
return"close"!==t?i.apply(e,s):(e.emit=i,n?i.apply(e,s):r?V(k,function(t){u.rename(I,k,function(n){t(function(){return n?o(n):(i.apply(e,s),void E())
})})}):(i.apply(e,s),E()),!0)},a()}var g,y={},E=function(e){return g?void(e?y.stream?y.stream.emit("error",e):console.error(e.stack):y.stream&&y.stream.emit("saved")):(g=!0,n(e,y))
}
if(t.stream&&!t.stream.readable)return E(new TypeError("options.stream must be readable."))
var w=t.stream
if(w){w.pause&&w.pause()
var x=[]
w.on("data",r),w.on("end",i)}var I,k="",N=t.mode||438&~It
c()}function j(e,t,n){_(e,{checkSymlinks:!1,sandbox:t.sandbox},function(e,t){return e?n(e):void x(t,function(e){return e?n(null,{}):("\\"===k&&(t=t.replace(/\\/g,"/")),void nt("mkdir",{args:["-p",t]},function(e){e&&e.message.indexOf("exists")>-1?n({code:"EEXIST",message:e.message}):n(null,{})
}))})})}function U(e,t,n){var r={}
return t.parents?j(e,t,n):void _(v(e),t,function(t,i){return t?n(t):(e=h(i,b(e)),void u.mkdir(e,function(e){return e?n(e):void n(null,r)
}))})}function B(e,t,n){_(e,t,function(e,r){return e?n(e):void u.appendFile(r,t.data,t,function(e){return e?n(e):void n(null,{})
})})}function q(e,t,n){O(e,u.unlink,t,n)}function F(e,t,n){t.recursive?O(e,function(e,t){nt("rm",{args:["-rf",e]},t)
},t,n):O(e,u.rmdir,t,n)}function H(e,t,n){var r,i
if(t.from)r=t.from,i=e
else{if(!t.to)return n(new Error("Must specify either options.from or options.to"))
r=e,i=t.to}var o={}
_(r,t,function(e,s){return e?n(e):void _(v(i),t,function(e,a){if(e)return n(e)
var c=h(a,b(i))
x(c,function(e){var a=/darwin|^win/.test(I.platform())&&s.toLowerCase()===c.toLowerCase()
if(!e||t.overwrite||a)u.rename(s,c,function(e){if(e)return n(e)
if(t.metadata!==!1){var s=yt
H(s+r,{to:s+i,metadata:!1},function(){n(null,o)})}})
else{var f=new Error("File already exists.")
f.code="EEXIST",n(f)}})})})}function G(e,t,n){function r(e,r){t.recursive?_(e,t,function(e,i){_(r,t,function(e,t){Y("cp",{args:["-a",i,t],stdoutEncoding:"utf8",stderrEncoding:"utf8",stdinEncoding:"utf8"},function(e,t){if(e)return n(e)
var i,o=t.process
o.stderr.on("data",function(e){e&&(i=!0,n(new Error(e)))}),o.stdout.on("end",function(){i||n(null,{to:r,meta:null})
})})})}):M(e,{sandbox:t.sandbox},function(e,i){return e?n(e):void P(r,{stream:i.stream,sandbox:t.sandbox},function(e,t){n(e,{to:r,meta:t})
})})}var i,o
if(t.from)i=t.from,o=e
else{if(!t.to)return n(new Error("Must specify either options.from or options.to"))
i=e,o=t.to}t.overwrite?r(i,o):_(o,t,function(e,s){return e?"ENOENT"==e.code?r(i,o):n(e):void u.stat(s,function(e,s){if(e||!s||s.err)r(i,o)
else{var a=o.replace(/(?:\.([\d]+))?(\.[^\.\/\\]*)?$/,function(e,t,n){return"."+(parseInt(t,10)+1||1)+(n?n:"")
})
G(i,{to:a,overwrite:!1,recursive:t.recursive,sandbox:t.sandbox},n)}})})}function z(e,t,n){if(!t.target)return n(new Error("options.target is required"))
var r={}
_(v(e),t,function(i,o){return i?n(i):(e=h(o,b(e)),void _(t.target,t,function(t,i){return t?n(t):void u.symlink(i,e,function(e){return e?n(e):void n(null,r)
})}))})}function W(e,t,n){function r(n){function r(e){if(n)return n(e)
throw new Error("File does not exist")}function i(){Tt[e]&&(Tt[e]=Tt[e].filter(function(e){return e!==d
}),Tt[e].length||delete Tt[e])}try{if(i(),Tt[e]=Tt[e]||[],Tt[e].push(d),t.file)c=u.watchFile(e,{persistent:!1},o),c.close=function(){i(),u.unwatchFile(e)
}
else{c=u.watch(e,{persistent:!1},o)
var s=c.close.bind(c)
c.close=function(){i(),s()}}c.on("error",function(t){console.error("[Watcher error]",t,e)})}catch(a){return r(a)
}n&&n(null,d)}function i(){c&&c.close()}function o(e,t){return l===!1?p(e,t):(clearTimeout(s),s=setTimeout(function(){p(e,t)
},350),void("delete"!=e&&(i(),setTimeout(function(){try{r()}catch(n){"ENOENT"==n.code&&(e="delete",m(e,t),clearTimeout(s))
}},15))))}var s,a,c,f=[],l=t.persistent,d=this,p=this.handleWatchEvent=function(t,n,r){n&&"~"==n.substr(-1)&&"."==n.charAt(0)||T(g(e),e,function(o){if(o.vfsWrite=r||!1,o.err)t="delete",i()
else if(a)return t="directory",void u.readdir(e,function(r,i){function s(){var t=i[u]
if(!t)return a()
var n=h(e,t)
T(t,n,function(e){i[u++]=e,(!c||e.mtime>c.mtime)&&(c=e),s()})}function a(){c&&"~"==c.name.substr(-1)&&"."==c.name.charAt(0)||m(t,n,o,i)
}if(r)return t="error",m(t,n,o,r)
var c,u=0
s()})
m(t,n,o)})},m=this.sendToAllListeners=function(e,t,n,r){f.forEach(function(i){i(e,t,n,r)})}
this.close=function(){f=[],c&&(c.removeListener("change",p),c.close())},this.on=function(e,t){"change"!=e?c.on.apply(c,arguments):f.push(t)
},this.removeListener=function(e,t){"change"!=e?c.removeListener.apply(c,arguments):f.splice(f.indexOf(t),1)
},this.pause=function(){i()},this.resume=function(e){return f.length?void r(e):e()},u.stat(e,function(e,t){return e?(n(e),m("delete")):(void 0===a&&(a=t&&t.isDirectory()),void r(n))
})}function J(e,t,n){_(e,t,function(e,r){return N&&Ct(r)?n(!0):e?n(e):void new W(r,t,function(e,t){return e?n(e):void n(null,{watcher:t})
})})}function V(e,t){function n(t){if(!r.length)return t()
var i=r.pop()
u.stat(e,function(t,n){!t&&n&&(n.vfsWrite=!0,i.sendToAllListeners("change",b(e),n))}),i.resume(function(){n(t)
})}if(!Tt[e])return t(function(e){e()})
{var r=Tt[e].slice(),i=v(e)+"/";(Tt[i]||[]).slice()}r.forEach(function(e){e.pause()}),t(n)}function X(e,t,n){function r(){var s=!1,a=f.connect(e,"127.0.0.1",function(){s||(s=!0,t.hasOwnProperty("encoding")&&a.setEncoding(t.encoding),n(null,{stream:a}))
})
a.once("error",function(e){if("ECONNREFUSED"===e.code&&i)return setTimeout(r,o),i--,void(o*=2)
if(!s)return s=!0,n(e)})}var i=t.hasOwnProperty("retries")?t.retries:5,o=t.hasOwnProperty("retryDelay")?t.retryDelay:50
r()}function K(e,t,n){_(e,t,function(e,r){return e?n(e):void w("chmod",[t.mode,r],{},function(e,t,r){return e?(e.stderr=r,e.stdout=t,n(e)):void n(null,{})
})})}function Y(e,t,n){if(kt)return kt.push(Y.bind(null,e,t,n))
var r=t.args||[]
it(t),_(e,{nocheck:1,alreadyRooted:!0},function(e,i){if(e)return n(e)
var o
try{o=l.spawn(i,r,t)}catch(e){return n(e)}t.resumeStdin&&o.stdin.resume(),t.hasOwnProperty("stdoutEncoding")&&o.stdout&&o.stdout.setEncoding(t.stdoutEncoding),t.hasOwnProperty("stderrEncoding")&&o.stderr&&o.stderr.setEncoding(t.stderrEncoding),o.on("error",function(){o.emit("exit",127)
}),n(null,{process:o})})}function $(e,t,n){var r=t.args||[]
delete t.args,it(t),delete t.env.TMUX,t.testing&&r.forEach(function(e,t){r[t]=e.replace(/^~/,process.env.HOME)
}),_(e,{nocheck:1,alreadyRooted:!0},function(e,i){function o(e){if(!e){var o=new Error("ENOENT: file not found "+i)
return o.code="ENOENT",n(o)}var s
try{s=ht.spawn(i,r,t),s.on("error",function(){}),s.resizeOrig=s.resize,s.resize=function(e,t){try{s.resizeOrig(e,t)
}catch(n){return void console.error("error when resizing terminal",n)}s.emit("data",{rows:t,cols:e}),mt||(/v0\.([123456789]\..*|10\.(0|1|2[0-7]))/.test(process.version)?s.emit("data",{message:"Wrong Node.js version: "+process.version,code:"EINSTALL"}):"cloud91.6"==wt?s.emit("data",{message:"Wrong TMUX version: 1.6",code:"EINSTALL"}):pt&&s.emit("data",{message:"Please make sure TMUX is installed",code:"EINSTALL"}),mt=!0)
}}catch(o){return n(o)}n(null,{pty:s})}return e?n(e):void(t.validatePath?u.exists(i,o):o(!0))})}function Q(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s"']/g,"\\$&")
}function Z(e,n,r){function i(e,t){t||(t=0),w(gt,["-u2","-L",c,"-C","list-panes","-F","c9-pid-#{pane_pid}-#{pane_dead}-#{pane_status}","-t",u],{maxBuffer:1024e3},function(n,r){var o=/c9-pid-(\d+)-(\d)-/.exec(r),s=parseInt(o&&o[2],10),a=s?0:parseInt(o&&o[1],10)
return!a&&!s&&10>t?void setTimeout(i.bind(null,e,++t),30):void e(n,{pid:a||-1})})}function o(e){return Object.keys(e).filter(function(e){return"#"==e[0]
}).join("")}function s(e,t){var n=t.split(""),r={}
return Object.keys(e).forEach(function(t,i){if("#"==t[0]){var o=n[i]
i>=e.numberDataIndex&&(o=parseInt(o,10)),r[e[t]]=o}}),r}function a(e){function i(i){return i?r(i):n.detach&&n.output?(it(n),delete n.env.TMUX,w(gt,o,{args:o,name:n.name,cwd:n.cwd,resolve:n.resolve,env:n.env},function(e,t){var n=/c9-pid(\d+)-/.exec(t),i=parseInt(n&&n[1],10)
r(e,{pid:i})})):void $(gt,{args:o,name:n.name,cols:n.cols,rows:n.rows,cwd:n.cwd,resolve:n.resolve,env:n.env},function(n,i){return n?(t("TMUX ERROR: "+n.message),r(n)):(e||i.pty.on("data",function o(e){if(e&&i.pty.removeListener("data",o),e.indexOf("can't create socket")>-1){var t=new Error(e)
t.type="exception",t.code="EPERM",i.pty.emit("data",t)}}),r(null,i),void(e&&i.pty.emit("data",{started:!0})))
})}var o=[]
n.env||(n.env={}),e?(o=["-u2","-L",c,"attach","-t",n.session],n.detachOthers&&(/v0\.([123456789]\..*|10\.(0|1|2[0-7]))/.test(process.version)?console.log("detachOthers not supported, ignoring"):o.push("-d"))):(o=["-u2","-L",c,"new","-s",n.session],n.terminal?o.push("export ISOUTPUTPANE=0;"+(n.defaultEditor?" export EDITOR='`which c9` open --wait'; ":"")+vt+" -l"):n.idle?o.push(vt+" -l -c 'printf \"\\e[01;34m[Idle]\\e[0m\\n\"; sleep 0.1;'"):n.command&&o.push(vt+" -l -c '"+n.command.replace(/'/g,"'\\''")+'; printf "\\e[01;30m\\n\\nProcess exited with code: $?\\e[0m\\n"; sleep 0.1;\''),o.push(";","set","-q","-g","status","off",";","set","-q","destroy-unattached","off",";","set","-q","mouse-select-pane","on",";","set","-q","set-titles","on",";","set","-q","quiet","on",";","set","-q","-g","prefix","C-b",";","set","-q","-g","terminal-overrides","'xterm:colors=256'"),o.push(";","setw","c0-change-trigger","0"),n.output&&o.push(";","set","-q","remain-on-exit","on",";","setw","-q","-g","aggressive-resize","on"),n.detach&&n.output&&(o.unshift("-C"),o.push(";","list-panes","-F","c9-pid#{pane_pid}-")),n.detach&&o.push(";","detach"),n.env.LD_LIBRARY_PATH=(n.env.LD_LIBRARY_PATH?n.env.LD_LIBRARY_PATH+":":"")+"~/.c9/local/lib",n.env.ISOUTPUTPANE="1"),i()
}var c=n.tmuxName||wt,u=n.session
if(n.fetchpid)return i(r)
if(n.capturePane){n=n.capturePane,p=["-u2","-L",c,"capture-pane",n.joinLines!==!1?"-peJ":"-pe","-S",n.start,"-E",n.end,"-t",n.pane]
var f
try{f=l.spawn(gt,p,n)}catch(d){return r(d)}return f.stdout.setEncoding("utf8"),f.stderr.setEncoding("utf8"),f.on("error",function(){f.emit("exit",127)
}),void r(null,{process:f})}if(n.getStatus){n=n.getStatus
var h=n.id,p=["-u2","-L",c],m={"#S":"session","#{pane_current_path}":"path","#{pane_current_command}":"command","#{pane_width}":"width","#{pane_height}":"height","#{history_limit}":"length","#{history_size}":"line","#{cursor_x}":"x","#{cursor_y}":"y","#{saved_cursor_x}":"savedX","#{saved_cursor_y}":"savedY","#{scroll_region_lower}":"scrollRegionLower","#{scroll_region_upper}":"scrollRegionUpper",numberDataIndex:3},g={"#{client_session}":"session","#{client_created}":"created","#{client_activity}":"activity","#{client_width}":"width","#{client_height}":"height",numberDataIndex:1}
return p.push("list-panes","-F",o(m)),h?p.push("-t",h):p.push("-a"),n.listClients!==!1&&(p.push(";","list-clients","-F","\n"+o(g)),h&&p.push("-t",h)),w(gt,p,function(e,t){var n={},i=!1;
(t||"").split("\n").forEach(function(e){if(!e)return i=!0
var t
if(i){var r=s(g,e)
t=n[r.session],t&&t.clients.push(r)}else t=s(m,e),n[t.session]=t,t.clients=[]}),h&&(n=n[h]),r(e,{status:n})
})}if(n.kill){if(!n.session)return r(new Error("Missing session name"))
w(gt,["-L",c,"-C","kill-session","-t",n.session],function(e){return n.command?void a():r(e,{})})}else if(n.attach){if(!n.session)return r(new Error("Missing session name"))
!function v(e){w(gt,["-u2","-L",c,"list-sessions"],function(t,r){t&&(r="")
var i=new RegExp("^"+Q(n.session)+":","m")
r.match(i)?a(!0):n.output&&100>e?setTimeout(v.bind(null,++e),10):a(!1)})}(0)}else a()}function et(e,t,n){function r(){s||(s=!0,o("data",["\n[1mPane is dead[H"]),e.kill(),e.kill=function(){})
}function i(n){if(c[n]=c[n]||[],!t||"exit"!=n&&"close"!=n&&"end"!=n)e.on(n,function(){o(n,arguments)})
else{if("exit"!=n)return
e.on("exit",function(){r()})}}function o(t,n){c[t]&&c[t].forEach(function(t){t.apply(e,n)})}if(n)return n.attachTo(e,t)
var s=!1,a=!1
this.readable=!0,this.writable=!0,this.__defineGetter__("pid",function(){return s?-1:e.pid}),this.attachTo=function(t){return e=t,s=!1,a=!1,this.readable=!0,this.writable=!0,Object.keys(c).forEach(i),this
},this.killtree=this.kill=t?function(t){return-1==t?(s?o("kill"):(r(),e.on("exit",function(){o("kill")
})),void(e.suspended=!0)):(a=!0,o("end"),void o("exit"))}:function(){e.kill(),e.kill=function(){}},this.destroy=function(){e.destroy.apply(e,arguments)
},this.end=function(){e.end.apply(e,arguments)},this.write=function(){e.write.apply(e,arguments)}
var c={}
this.on=this.addListener=function(e,t){c[e]||i(e),c[e].push(t)},this.off=this.removeListener=function(e,t){var n=c[e].indexOf(t)
n>-1&&c[e].splice(n,1)},this.emit=o}function tt(e,t,n){function r(){var e="session"+Math.round(1e3*Math.random())
return Rt[e]?r():e}function i(){function e(e){return e?n(e):void $(t.BASH||vt,{args:i,name:t.name,cols:t.cols,rows:t.rows,cwd:t.cwd,resolve:t.resolve,env:t.env||{}},function(e,r){if(e)return n(e)
s.pty=r.pty=new et(r.pty,t.output,s.pty)
var i=s.wait
return delete s.wait,i.forEach(function(e){e(null,{pty:s.pty})}),r.pty.on("exit",function(){delete Rt[o]
}),t.detach&&t.output?void s.pty.on("data",function a(){s.pid=r.pid=s.pty.pid,n(null,r),s.pty.removeListener("data",a)
}):void n(null,r)})}if(!t.session)return n(new Error("Missing session name"))
var i=["-l","-i"],o=t.session||r(),s=Rt[o]||{}
if(Rt[o]=s,s.wait||(s.wait=[]),t.idle?t.command="echo '[2J[1;1H[01;34m[Idle][0m'":t.command&&(t.command="echo '[2J[1;1H';"+t.command+';printf "[01;30m\n\nProcess exited with code: $?[0m\n"'),t.command){i.push("-c","nodosfilewarning=1;"+t.command)
var a=i[i.length-1]
i[i.length-1]='"'+a.replace(/"/g,'\\"')+'"'}e()}var o
if(t.fetchpid)return o=Rt[t.session],void setTimeout(function(){n(null,{pid:o&&o.pty?o.pty.pid:-1})},100)
if(t.capturePane)return n(new Error("Not Supported on Windows"))
if(t.kill){if(o=Rt[t.session],o&&o.pty.kill(),!t.command)return n(o?null:new Error("No Session Found"),{})
i()}else if(t.attach){if(!t.session)return n(new Error("Missing session name"))
o=Rt[t.session],o?o.wait?o.wait.push(n):o.pty&&!o.pty.suspended&&n(null,{pty:o.pty}):i()}else t.session&&Rt[t.session]&&n(new Error("Session Already Started")),i()
}function nt(e,t,n){return kt?kt.push(nt.bind(null,e,t,n)):void(N&&rt(e,t,n)||(it(t),_(e,{nocheck:1,alreadyRooted:!0},function(e,r){return e?n(e):void w(r,t.args||[],t,function(e,t,r){return e?(e.stderr=r,e.stdout=t,n(e)):void n(null,{stdout:t,stderr:r})
})})))}function rt(e,t,n){if("kill"==e){var r=t.args&&t.args[0]
return Object.keys(Rt).some(function(e){return Rt[e].pid==r&&Rt[e].pty?(Rt[e].pty.killtree(-1),!0):void 0
}),n(),!0}}function it(t){t.hasOwnProperty("env")?t.env.__proto__=e.defaultEnv:t.env=e.defaultEnv
var n={}
for(var r in t.env)n[r]=t.env[r]
t.env=n,t.cwd&&"~"==t.cwd.charAt(0)&&(t.cwd=t.env.HOME+t.cwd.substr(1)),a&&t.cwd&&(t.cwd=a(t.cwd))}function ot(e,t,n){var r=t.code||t.graceful?"SIGTERM":"SIGKILL"
st(e,function i(e,o){return e?n(e):(o.forEach(function(e){if(e==process.pid)return setTimeout(function(){process.kill(e,r)
})
try{process.kill(e,r)}catch(t){if("ESRCH"==t.code)return}}),void(t.graceful&&"SIGKILL"!=r?(r="SIGKILL",setTimeout(function(){i(null,o)
},t.timeout||800)):n(null,{})))})}function st(e,t){return N?t(null,[e]):void w("ps",["-A","-oppid,pid"],function(n,r){function i(e){for(var t=e.concat(),n=0;n<e.length;n++){var r=o[e[n]]
r&&t.push.apply(t,i(r))}return t}if(n)return t(n)
var o={}
r.split("\n").slice(1).forEach(function(e){var t=e.trim().split(/\s+/g);(o[t[0]]||(o[t[0]]=[])).push(parseInt(t[1]))
}),t(null,i([e]))})}function at(e,t,n){St[e]||(St[e]=[]),St[e].push(t),n&&n()}function ct(e,t,n){var r=St[e]
if(r){var i=r.indexOf(t)
i>=0&&r.splice(i,1)}n&&n()}function ut(e,t,n){var r=St[e]
if(r)for(var i=0,o=r.length;o>i;i++)r[i](t)
n&&n()}function ft(e,t,i){function s(n){delete t.code,delete t.stream,delete t.file,n(Ot,t,function(t,n){return t?i(t):(n.names=Object.keys(n),n.name=e,o(n),n.on&&console.warn("Warning: "+e+" exports 'on' symbol that will be overwritten"),Nt[e]=n,a.api=n,void i(null,a))
})}var a={}
if(!t.redefine&&Nt.hasOwnProperty(e)){var c=new Error("EEXIST: Extension API already defined for "+e)
return c.code="EEXIST",i(c,{api:Nt[e]})}t.redefine&&Nt[e]&&Nt[e].destroy&&Nt[e].destroy()
var u
if(t.file){try{u=require(t.file)}catch(c){return i(c)}s(u)}else if(t.code){try{u=r(t.code,e)}catch(c){return i(c)
}s(u)}else{if(!t.stream)return i(new Error("must provide `file`, `code`, or `stream` when cache is empty for "+e))
n(t.stream,function(e,t){if(e)return i(e)
var n
try{n=r(t)}catch(e){return i(e)}s(n)})}}function lt(e,t,n){Nt[e]&&Nt[e].destroy&&Nt[e].destroy(),delete Nt[e],n(null,{})
}function dt(e,t,n){var r=Nt[e]
if(!r){var i=new Error("ENOENT: There is no API extension named "+e)
return i.code="ENOENT",n(i)}n(null,{api:r})}var ht
e.nodePath&&(process.env.NODE_PATH=e.nodePath,require("module")._initPaths()),e.nopty||([(e.nodePath||process.env.HOME+"/.c9/node_modules")+"/pty.js","pty.js","pty.nw.js"].some(function(e){try{return ht=require(e),!0
}catch(t){console.warn(t,e)}}),ht||console.warn("unable to initialize pty.js:")),ht||(ht=function(){console.log("PTY is not supported.")
},ht.spawn=ht)
var pt,mt,gt=e.tmuxBin||"tmux",vt=e.bashBin||process.env.C9_BASH_BIN||(N?"bash.exe":"bash"),bt=e.metapath,yt=e.wsmetapath,Et=e.testing,wt="cloud9",xt=e.root
if(!xt)throw new Error("root is a required option")
if(xt=m(xt),"/"==k&&"/"!==xt[0])throw new Error("root path must start in /")
"/"!==xt[xt.length-1]&&(xt+="/")
var _t=xt.substr(0,xt.length-1),It=18
w(vt,["-c","umask"],function(e,t,n){e||n||!t||(It=parseInt(t,8))}),w(gt,["-V"],function(e,t){e&&(t="tmux 1.9"),pt=e&&"ENOENT"===e.code,wt="cloud9"+parseFloat(t.replace(/tmux /,""),10)
}),e.hasOwnProperty("defaultEnv")?e.defaultEnv.__proto__=process.env:e.defaultEnv=process.env
var kt=null
N||(kt=[],w(vt,["-lc","printenv -0"],function(t,n,r){var i=kt
if(kt=null,!t&&!r&&n){var o=e.defaultEnv
n.split("\x00").forEach(function(e){var t=e.indexOf("=");-1!=t&&(o[e.slice(0,t)]=e.slice(t+1))})}i.forEach(function(e){e()
})}))
var Nt={},St={},Tt={},Ot=o({resolve:A,stat:C,readfile:M,readdir:L,mkfile:P,mkdir:U,mkdirP:j,appendfile:B,rmfile:q,rmdir:F,rename:H,copy:G,symlink:z,chmod:K,metadata:R,getMetadata:D,watch:J,connect:X,spawn:Y,pty:$,tmux:"win32"==process.platform?tt:Z,execFile:nt,killtree:ot,on:at,off:ct,emit:ut,extend:ft,unextend:lt,use:dt})
if(N)var At=function(e,t){return"/"==e?(nt("cmd",{args:["/c","wmic logicaldisk get deviceid"]},function(e,n){if(n&&n.stdout){var r=n.stdout.match(/ *\w:/g).map(function(e){return e.trim()
}),o={},s={isFile:function(){return!1},size:0,mtime:Date.now()}
o.etag=i(s),i(s),o.stream=new y,o.stream.readable=!0,t(null,o),r.forEach(function(e){o.stream.emit("data",{mime:"drive/directory",mtime:s.mtime,name:e,size:0})
}),o.stream.emit("end")}}),!0):void 0},Ct=function(e){return"/"==e}
var Rt={}
if(e.extendApi)for(var Dt in e.extendApi)ft(Dt,e.extendApi[Dt],function(){})
return Ot}}),define("simple-mime",function(e){var t
e.exports=function(e){return function(n){n=n.toLowerCase().trim()
var r=n.lastIndexOf("/")
return r>=0&&(n=n.substr(r+1)),r=n.lastIndexOf("."),r>=0&&(n=n.substr(r+1)),t[n]||e}},t={"3gp":"video/3gpp",a:"application/octet-stream",ai:"application/postscript",aif:"audio/x-aiff",aiff:"audio/x-aiff",asc:"application/pgp-signature",asf:"video/x-ms-asf",asm:"text/x-asm",asx:"video/x-ms-asf",atom:"application/atom+xml",au:"audio/basic",avi:"video/x-msvideo",bat:"application/x-msdownload",bin:"application/octet-stream",bmp:"image/bmp",bz2:"application/x-bzip2",c:"text/x-csrc",cab:"application/vnd.ms-cab-compressed",can:"application/candor",cc:"text/x-c++src",chm:"application/vnd.ms-htmlhelp","class":"application/octet-stream",com:"application/x-msdownload",conf:"text/plain",cpp:"text/x-c",crt:"application/x-x509-ca-cert",css:"text/css",csv:"text/csv",cxx:"text/x-c",deb:"application/x-debian-package",der:"application/x-x509-ca-cert",diff:"text/x-diff",djv:"image/vnd.djvu",djvu:"image/vnd.djvu",dll:"application/x-msdownload",dmg:"application/octet-stream",doc:"application/msword",dot:"application/msword",dtd:"application/xml-dtd",dvi:"application/x-dvi",ear:"application/java-archive",eml:"message/rfc822",eps:"application/postscript",exe:"application/x-msdownload",f:"text/x-fortran",f77:"text/x-fortran",f90:"text/x-fortran",flv:"video/x-flv","for":"text/x-fortran",gem:"application/octet-stream",gemspec:"text/x-script.ruby",gif:"image/gif",gyp:"text/x-script.python",gypi:"text/x-script.python",gz:"application/x-gzip",h:"text/x-chdr",hh:"text/x-c++hdr",htm:"text/html",html:"text/html",ico:"image/vnd.microsoft.icon",ics:"text/calendar",ifb:"text/calendar",iso:"application/octet-stream",jar:"application/java-archive",java:"text/x-java-source",jnlp:"application/x-java-jnlp-file",jpeg:"image/jpeg",jpg:"image/jpeg",js:"application/javascript",json:"application/json",less:"text/css",log:"text/plain",lua:"text/x-script.lua",luac:"application/x-bytecode.lua",makefile:"text/x-makefile",m3u:"audio/x-mpegurl",m4v:"video/mp4",man:"text/troff",manifest:"text/cache-manifest",markdown:"text/x-markdown",mathml:"application/mathml+xml",mbox:"application/mbox",mdoc:"text/troff",md:"text/x-markdown",me:"text/troff",mid:"audio/midi",midi:"audio/midi",mime:"message/rfc822",mml:"application/mathml+xml",mng:"video/x-mng",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mp4v:"video/mp4",mpeg:"video/mpeg",mpg:"video/mpeg",ms:"text/troff",msi:"application/x-msdownload",odp:"application/vnd.oasis.opendocument.presentation",ods:"application/vnd.oasis.opendocument.spreadsheet",odt:"application/vnd.oasis.opendocument.text",ogg:"application/ogg",p:"text/x-pascal",pas:"text/x-pascal",pbm:"image/x-portable-bitmap",pdf:"application/pdf",pem:"application/x-x509-ca-cert",pgm:"image/x-portable-graymap",pgp:"application/pgp-encrypted",pkg:"application/octet-stream",pl:"text/x-script.perl",pm:"text/x-script.perl-module",png:"image/png",pnm:"image/x-portable-anymap",ppm:"image/x-portable-pixmap",pps:"application/vnd.ms-powerpoint",ppt:"application/vnd.ms-powerpoint",ps:"application/postscript",psd:"image/vnd.adobe.photoshop",py:"text/x-script.python",qt:"video/quicktime",ra:"audio/x-pn-realaudio",rake:"text/x-script.ruby",ram:"audio/x-pn-realaudio",rar:"application/x-rar-compressed",rb:"text/x-script.ruby",rdf:"application/rdf+xml",roff:"text/troff",rpm:"application/x-redhat-package-manager",rss:"application/rss+xml",rtf:"application/rtf",ru:"text/x-script.ruby",s:"text/x-asm",sgm:"text/sgml",sgml:"text/sgml",sh:"application/x-sh",sig:"application/pgp-signature",snd:"audio/basic",so:"application/octet-stream",svg:"image/svg+xml",svgz:"image/svg+xml",swf:"application/x-shockwave-flash",t:"text/troff",tar:"application/x-tar",tbz:"application/x-bzip-compressed-tar",tci:"application/x-topcloud",tcl:"application/x-tcl",tex:"application/x-tex",texi:"application/x-texinfo",texinfo:"application/x-texinfo",text:"text/plain",tif:"image/tiff",tiff:"image/tiff",torrent:"application/x-bittorrent",tr:"text/troff",ttf:"application/x-font-ttf",txt:"text/plain",vcf:"text/x-vcard",vcs:"text/x-vcalendar",vrml:"model/vrml",war:"application/java-archive",wav:"audio/x-wav",webapp:"application/x-web-app-manifest+json",webm:"video/webm",wma:"audio/x-ms-wma",wmv:"video/x-ms-wmv",wmx:"video/x-ms-wmx",wrl:"model/vrml",wsdl:"application/wsdl+xml",xbm:"image/x-xbitmap",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xslt:"application/xslt+xml",yaml:"text/yaml",yml:"text/yaml",zip:"application/zip"}
}),define("vfs-socket/worker",function(e,t){function n(e){function t(t,n){D[t]=function(e){M.onEvent&&M.onEvent(t,e)
},e.on(t,D[t],n)}function n(t,n){var r=D[t]
r&&(delete D[t],e.off(t,r,n))}function r(e){var t=new s,n=e.id
return t.id=n,T[n]=t,e.hasOwnProperty("readable")&&(t.readable=e.readable),e.hasOwnProperty("writable")&&(t.writable=e.writable),t.writable&&(t.write=function(e){return M.write(n,e)
},t.end=function(e){e?M.end(n,e):M.end(n)}),t.readable&&(t.destroy=function(){M.destroy(n)},t.resume=function(){M.resume(n)
},t.pause=function(){M.pause(n)}),t}function i(e){if(e.token)return e.token
for(L=(L+1)%1e4;O.hasOwnProperty(L);)L=(L+1)%1e4
var t=L
O[t]=e,e.id=t,e.on("error",function(e){M.onError&&M.onError(t,e)}),e.readable&&(e.on("data",function(n){M.onData&&M.onData(t,n)===!1&&e.pause&&e.pause()
}),e.on("end",function(e){delete O[t],M.onEnd&&M.onEnd(t,e)})),e.on("close",function(){delete O[t],M.onClose&&M.onClose(t)
})
var n={id:t}
return e.token=n,e.hasOwnProperty("readable")&&(n.readable=e.readable),e.hasOwnProperty("writable")&&(n.writable=e.writable),n
}function a(t,n){var r=t.pid
if(C.token)return n?t.pid:t.token
C[r]=t,t.on("exit",function(e,t){delete C[r],M.onExit&&M.onExit(r,e,t)}),t.on("close",function(){delete C[r],n||(delete O[t.stdout.id],delete O[t.stderr.id],delete O[t.stdin.id]),M.onProcessClose&&M.onProcessClose(r)
}),t.kill=function(t,n){e.killtree(r,{code:t},n||function(){})}
var o={pid:r}
return t.token=o,n?r:(o.stdin=i(t.stdin),o.stdout=i(t.stdout),o.stderr=i(t.stderr),o)}function c(e){if(!e||C[e.pid]==e)return e&&e.token
var t=a(e,!0)
delete e.token,!e.resume&&e.socket&&e.socket.resume&&(e.resume=e.socket.resume.bind(e.socket)),!e.pause&&e.socket&&e.socket.pause&&(e.pause=e.socket.pause.bind(e.socket))
var n=i(e)
return delete e.token,n.pid=t,e.token=n,e.on("kill",function(){M.onPtyKill&&M.onPtyKill(t)}),n}function u(e){do P=(P+1)%1e4
while(A.hasOwnProperty(P))
var t=P
A[t]=e,e.id=t,e.on("change",function(e,n,r,i){M.onChange&&M.onChange(t,e,n,r,i)})
var n={id:t}
return n}function f(e){var t=e.name
R[t]=e
var n={name:t,names:e.names}
return n}function l(e,t){var n=O[e]
n&&n.write(t)}function d(e){var t=O[e]
t&&(delete O[e],t.destroy&&("function"!=typeof t.destroy?console.trace("##### WEIRD STREAM: ",t,typeof t.destroy,typeof t.close):t.destroy()))
}function h(e,t){var n=O[e]
n&&(delete O[e],t?n.end(t):n.end())}function p(e){var t=O[e]
if(t)return t.resume&&t.resume()}function m(e){var t=O[e]
if(t)return t.pause&&t.pause()}function g(e,t){var n=C[e]
n&&n.kill(t)}function v(e){var t=C[e]
t&&(t.unref(),t.unreffed=!0)}function b(e,t,n){var r=C[e]
if(r)try{r.resize(t,n)}catch(i){}}function y(e){var t=A[e]
t&&(delete A[e],t.close())}function E(e,t,n){if("ping"===e&&"ping"===t&&"serverTime"===n[0]&&2===n.length){var r=Date.now(),i=n[1]
n[1]=function(e,t){return e?i(e):void i(null,{payload:t,serverTime:Date.now()-r})}}}function w(e,t,n){var r=R[e]
if(r){if(E(e,t,n),"function"==typeof n[n.length-1]){var i=n[n.length-1]
n[n.length-1]=function(e,t){return e||t&&"object"==typeof t?N(e,t,i):void i(e,t)}}r[t].apply(r,n)}}function x(e,t){var n=T[e]
n&&n.emit("data",t)}function _(e,t){var n=T[e]
n&&(delete T[e],n.emit("end",t))}function I(e){var t=T[e]
t&&(delete T[e],t.emit("close"))}function k(e){e()}function N(e,t,n){var r
if(e&&(r={stack:process.pid+": "+e.stack},e.hasOwnProperty("code")&&(r.code=e.code),e.hasOwnProperty("message")&&(r.message=e.message),e.hasOwnProperty("stdout")&&(r.stdout=e.stdout),e.hasOwnProperty("stderr")&&(r.stderr=e.stderr),!t))return n(r)
for(var o={},s=Object.keys(t||{}),l=0,d=s.length;d>l;l++){var h=s[l]
switch(h){case"stream":o.stream=i(t.stream)
break
case"process":o.process=a(t.process)
break
case"pty":o.pty=c(t.pty)
break
case"watcher":o.watcher=u(t.watcher)
break
case"api":o.api=f(t.api)
break
default:o[h]=t[h]}}n(r,o)}function S(t){return function(n,i,o){if("function"!=typeof o)return void console.error(t+": callback must be function",n,i)
if(i.stream&&(i.stream=r(i.stream)),null===n||void 0===n){console.error("refusing to process invalid request",n,i)
var s=new Error("refusing to process invalid request: missing path")
return s.code="EINVALIDPATH",o(s)}e[t](n,i,function(e,t){N(e,t,o)})}}o.call(this,{write:l,end:h,destroy:d,resume:p,pause:m,onData:x,onEnd:_,onClose:I,unref:v,kill:g,resize:b,close:y,call:w,subscribe:t,unsubscribe:n,emit:e.emit,ping:k,resolve:S("resolve"),stat:S("stat"),metadata:S("metadata"),readfile:S("readfile"),readdir:S("readdir"),mkfile:S("mkfile"),mkdir:S("mkdir"),mkdirP:S("mkdirP"),appendfile:S("appendfile"),rmfile:S("rmfile"),rmdir:S("rmdir"),rename:S("rename"),copy:S("copy"),chmod:S("chmod"),symlink:S("symlink"),watch:S("watch"),connect:S("connect"),spawn:S("spawn"),killtree:S("killtree"),pty:S("pty"),tmux:S("tmux"),execFile:S("execFile"),extend:S("extend"),unextend:S("unextend"),use:S("use")})
var T={},O={},A={},C={},R={},D={},M=this.remoteApi
this.on("drain",function(){Object.keys(O).forEach(function(e){var t=O[e]
t.readable&&t.resume&&t.resume()}),Object.keys(T).forEach(function(e){var t=T[e]
t.writable&&t.emit("drain")})}),this.on("disconnect",function(e){e||(e=new Error("EDISCONNECT: vfs socket disconnected"),e.code="EDISCONNECT"),Object.keys(C).forEach(function(e){var t=C[e]
t.unreffed||t.kill(),delete C[e]}),Object.keys(O).forEach(function(t){var n=O[t]
n.emit("close",e)}),Object.keys(T).forEach(I),Object.keys(A).forEach(function(e){var t=A[e]
delete A[e],t.close()})})
var L=1,P=1}var r=require("util").inherits,i=require("smith"),o=i.Agent,s=require("stream").Stream
t.smith=i,t.Worker=n,r(n,o)}),define("vfs-ssh/slave",function(e){e.exports=function(e,t){function n(){o(new Error("Received unexpected signal: SIGINT"),1)
}function r(){o(new Error("Received unexpected signal: SIGTERM"),2)}function i(e){o(e,3)}function o(e,t){console.log(process.pid,"Unhandled exception",(e.message||e).toString(),e.stack),setTimeout(function(){c.disconnect(e),setTimeout(function(){process.exit(t)
},500)},200)}process.title="vfs-worker "+JSON.stringify(e)
var s=require("vfs-socket/worker").Worker,a=require("vfs-local")(e),c=new s(a)
c.connect([process.stdin,process.stdout],t),c.on("disconnect",function(){process.removeListener("SIGINT",n),process.removeListener("SIGTERM",r),process.removeListener("uncaughtException",i),a.killtree(process.pid,{},function(e){e&&(console.error(e.stack),process.exit())
})}),process.on("SIGINT",n),process.on("SIGTERM",r),process.on("uncaughtException",i)}})
